<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>Sistem Informasi Tugas Akhir FIKPsi</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1)', 
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.4, 0, 0.2, 1)',
                        'pop-in': 'popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'bounce-slight': 'bounceSlight 2s infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        blob: {
                            "0%": { transform: "translate(0px, 0px) scale(1)" },
                            "33%": { transform: "translate(30px, -50px) scale(1.1)" },
                            "66%": { transform: "translate(-20px, 20px) scale(0.9)" },
                            "100%": { transform: "translate(0px, 0px) scale(1)" }
                        },
                        bounceSlight: {
                            "0%, 100%": { transform: "translateY(-3%)" },
                            "50%": { transform: "translateY(0)" }
                        }
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.4)',
                            border: 'rgba(255, 255, 255, 0.5)',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            background-color: #f3e8ff; /* Light Purple Bg */
            -webkit-font-smoothing: antialiased; 
            overflow: hidden; 
            color: #4c1d95; /* Deep Purple Text */
        }
        
        /* Background Blobs for Glass Effect */
        .blob-cont {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; pointer-events: none;
        }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: blob 10s infinite alternate;
        }
        .blob-1 { top: -10%; left: -10%; width: 600px; height: 600px; background: #c084fc; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 600px; height: 600px; background: #818cf8; animation-delay: 2s; }
        .blob-3 { top: 30%; left: 30%; width: 500px; height: 500px; background: #f472b6; animation-delay: 4s; opacity: 0.4; }

        /* Enhanced Glassmorphism */
        .glass { 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .touch-scroll { -webkit-overflow-scrolling: touch; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(168, 85, 247, 0.3); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(168, 85, 247, 0.6); }
        
        .input-modern { 
            width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; 
            background-color: rgba(255, 255, 255, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.9); 
            outline: none; color: #4c1d95; transition: all 0.2s;
            backdrop-filter: blur(4px);
        }
        .input-modern:focus { 
            background-color: rgba(255, 255, 255, 1);
            border-color: #a855f7; 
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15); 
            transform: translateY(-1px);
        }

        .textarea-modern {
            width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; 
            background-color: rgba(255, 255, 255, 0.7); 
            border: 1px solid rgba(255, 255, 255, 0.9); 
            outline: none; color: #4c1d95; transition: all 0.2s;
            backdrop-filter: blur(4px);
            min-height: 100px;
            resize: vertical;
        }
        .textarea-modern:focus { 
            background-color: rgba(255, 255, 255, 1);
            border-color: #a855f7; 
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15); 
            transform: translateY(-1px);
        }

        /* Typing Indicator Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .animate-bounce-slight { animation: bounceSlight 2s infinite; }
    </style>
</head>
<body class="antialiased text-slate-800">
    <div class="blob-cont">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS (Lucide Style) ---
        const Icon = ({ path, className = "w-5 h-5", size = 20 }) => <svg className={className} width={size} height={size} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={path} /></svg>;
        const PATHS = {
            Home: "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z M9 22V12h6v10",
            Sparkles: "M9.937 15.5A2 2 0 008.5 14.063l-6.135-1.582a.5.5 0 010-.962l6.135-1.583A2 2 0 009.937 8.5l1.582-6.135a.5.5 0 01.963 0l1.582 6.135a2 2 0 001.437 1.437l6.135 1.583a.5.5 0 010 .962l-6.135 1.583a2 2 0 00-1.437 1.437l-1.582 6.135a.5.5 0 01-.963 0z",
            Lock: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
            Trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
            Plus: "M12 5v14m-7-7h14",
            Search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            Menu: "M4 6h16M4 12h16M4 18h16",
            Users: "M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M16 3.13a4 4 0 010 7.75",
            User: "M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2 M12 11a4 4 0 100-8 4 4 0 000 8z",
            Book: "M4 19.5A2.5 2.5 0 016.5 17H20 M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z",
            Chart: "M18 20V10 M12 20V4 M6 20v-6",
            Send: "M22 2L11 13 M22 2l-7 20-4-9-9-4 20-7z",
            Cloud: "M5.5 16a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 16h-8z",
            Graduation: "M22 10v6M2 10l10-5 10 5-10 5z M6 10l0 .6c0 2.4 2 4.5 5.7 4.9L12 16",
            Cog: "M12 15a3 3 0 100-6 3 3 0 000 6z M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010 2.83l.06-.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z",
            Download: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4 M7 10l5 5 5-5 M12 15V3",
            Upload: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4 M17 8l-5-5-5 5 M12 3v12",
            ChevronDown: "M6 9l6 6 6-6",
            ArrowLeft: "M19 12H5 M12 19l-7-7 7-7",
            FileText: "M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z M14 2v6h6",
            Clip: "M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48",
            Logout: "M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4 M16 17l5-5-5-5 M21 12H9",
            X: "M18 6L6 18M6 6l12 12",
            Eye: "M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z M12 15a3 3 0 100-6 3 3 0 000 6z",
            ExternalLink: "M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6 M15 3h6v6 M10 14L21 3",
            Robot: "M12 8V4H8 M16 4h-4 M4 14a2 2 0 012-2h12a2 2 0 01-2 2H6a2 2 0 01-2-2v-6z M10 18h4 M9 13v2 M15 13v2",
            Info: "M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
            Sun: "M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z",
            Edit: "M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V8z",
            FileUp: "M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5 M12 3v12",
            Bell: "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9",
            Refresh: "M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15",
            Wifi: "M5 12.55a11 11 0 0114.08 0 M1.42 9a16 16 0 0121.16 0 M8.53 16.11a6 6 0 016.95 0 M12 20h.01",
            Tag: "M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z",
            Mail: "M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z",
            Inbox: "M22 12h-6l-2 3h-4l-2-3H2v12h20V12z",
            PaperPlane: "M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z",
            MessageCircle: "M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z",
            Minimize2: "M4 14h6v6 M20 10h-6V4 M14 10l7-7 M3 21l7-7", 
            List: "M8 6h13 M8 12h13 M8 18h13 M3 6h.01M3 12h.01M3 18h.01",
            Calendar: "M19 4h-1V3a1 1 0 00-2 0v1H8V3a1 1 0 00-2 0v1H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm0 16H5V9h14v11z",
            CheckCircle: "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z",
            AlertCircle: "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z",
            Clock: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
            MessageSquare: "M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z",
            ChevronRight: "M9 18l6-6-6-6",
            Home: "M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z M9 22V12h6v10"
        };

        const AUTH_TOKEN = "MTAxMDE5OTA="; 

        // --- HELPER: TANGGAL ---
        const formatDateId = (dateString, includeTime = false) => {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                };
                
                if (includeTime) {
                    options.hour = '2-digit';
                    options.minute = '2-digit';
                }
                
                return date.toLocaleDateString('id-ID', options);
            } catch (e) {
                return dateString;
            }
        };

        // --- DATA ---
        const INITIAL_DB = {
            'Data Dosen': [
                { id: 1, Nama: "Dr. Budi Santoso", NIDN: "112233", Keahlian: "Epidemiologi", Kuota: 10, Terisi: 5 },
                { id: 2, Nama: "Prof. Siti Aminah", NIDN: "445566", Keahlian: "Kesehatan Lingkungan", Kuota: 8, Terisi: 7 },
                { id: 3, Nama: "Rudi Hermawan, M.Kes", NIDN: "778899", Keahlian: "Promosi Kesehatan", Kuota: 12, Terisi: 3 }
            ],
            'Data Peminatan': [
                { id: 1, Nama: "PKIP" },
                { id: 2, Nama: "KESLING" },
                { id: 3, Nama: "KESPRO" },
                { id: 4, Nama: "EPID" },
                { id: 5, Nama: "GIZI KESMAS" },
                { id: 6, Nama: "K3" }
            ],
            'Mahasiswa Tugas Akhir': [
                { id: 1, Nama: "Ahmad Dani", NPM: "2020001", Prodi: "S1 Ilmu Kesehatan Masyarakat", Angkatan: "2020", Peminatan: "EPID", WhatsApp: "08123456789", Judul: "Analisis Faktor Risiko DBD", Pembimbing_1: "Dr. Budi Santoso", Pembimbing_2: "Rudi Hermawan, M.Kes", Penguji: "Prof. Siti Aminah", Status: "Sudah Hasil", StatusAkademik: "Aktif", BimbinganCount: 5, ProgresDeskripsi: "Sudah revisi bab 4", LinkLaporan: "https://drive.google.com/...", ProgresBab: "Bab 4" }, // Added ProgresBab
                { id: 2, Nama: "Rina Wati", NPM: "2020002", Prodi: "S1 Ilmu Kesehatan Masyarakat", Angkatan: "2020", Peminatan: "KESLING", WhatsApp: "08987654321", Judul: "Higiene Sanitasi Makanan Jajanan", Pembimbing_1: "Prof. Siti Aminah", Pembimbing_2: "-", Penguji: "Dr. Budi Santoso", Status: "Sudah Proposal", StatusAkademik: "Aktif", BimbinganCount: 2, ProgresDeskripsi: "Persiapan turun lapangan", LinkLaporan: "", ProgresBab: "Penelitian" },
                { id: 3, Nama: "Budi Setiawan", NPM: "2020003", Prodi: "S1 Psikologi", Angkatan: "2020", Peminatan: "Psikologi Industri", WhatsApp: "08123456700", Judul: "Pengaruh Work From Home Terhadap Kinerja", Pembimbing_1: "Rudi Hermawan, M.Kes", Pembimbing_2: "-", Penguji: "-", Status: "Belum Proposal", StatusAkademik: "Cuti", BimbinganCount: 0, ProgresDeskripsi: "-", LinkLaporan: "", ProgresBab: "Pengambilan data awal proposal" },
            ],
            'Jadwal Ujian TA': [
                { id: 1, Mahasiswa: "Rina Wati", Jenis: "Seminar Proposal", Tanggal: "2024-12-15", Jam: "09:00", Ruang: "R. Sidang 1", Penguji_1: "Dr. Budi Santoso" }
            ],
            'Data Unduhan': [
                { id: 1, Judul: "Pedoman Penulisan Tugas Akhir 2024", Kategori: "Pedoman", Link: "#" },
            ],
            'Informasi': [
                { id: 1, Judul: "Jadwal Libur Semester", Isi: "Libur dimulai tanggal 25 Desember hingga 5 Januari.", Penulis: "Admin", Tanggal: "2024-12-20", Tipe: "Umum" }
            ],
            'BimbinganChats': [
                { id: 1, sender: "Ahmad Dani", receiver: "Dr. Budi Santoso", message: "Selamat pagi Dok, izin mengirimkan revisi Bab 1.", timestamp: new Date().toISOString(), type: 'text' },
                { id: 2, sender: "Dr. Budi Santoso", receiver: "Ahmad Dani", message: "Pagi. Baik, tolong perbaiki data prevalensinya.", timestamp: new Date().toISOString(), type: 'text' }
            ],
            'BimbinganJadwal': [
                { id: 1, studentName: "Ahmad Dani", advisorName: "Dr. Budi Santoso", date: '2023-11-20', time: '10:00', topic: 'Revisi Bab 1', status: 'completed' },
                { id: 2, studentName: "Ahmad Dani", advisorName: "Rudi Hermawan, M.Kes", date: '2023-11-25', time: '13:00', topic: 'Konsultasi Kuesioner', status: 'approved' }
            ],
            'Pengajuan Judul': [],
            'Pendaftaran Sempro': [],
            'Pendaftaran Semhas': [],
            'Pendaftaran Sidang': [],
            'Layanan Surat': [],
            'Laporan TA': [], 
            'Data Yudisium': [],
            'Konfigurasi': [
                { id: 1, app_name: 'SI Tugas Akhir FIKPsi', scriptUrl: '' }
            ]
        };

        const TABLE_CONFIG = {
            'Data Dosen': { 
                columns: [{key:'Nama', label:'Nama Lengkap'}, {key:'NIDN', label:'NIDN'}, {key:'Keahlian', label:'Bidang Keahlian'}, {key:'Kuota', label:'Kuota'}, {key:'Terisi', label:'Aktif'}], 
                form: [{key:'Nama', label:'Nama Lengkap'}, {key:'NIDN', label:'NIDN'}, {key:'Keahlian', label:'Keahlian'}, {key:'Kuota', label:'Kuota Maksimal', type:'number'}, {key:'Terisi', label:'Jumlah Bimbingan Saat Ini', type:'number'}]
            },
            'Data Peminatan': {
                columns: [{key: 'Nama', label: 'Nama Peminatan'}],
                form: [{key: 'Nama', label: 'Nama Peminatan'}]
            },
            'Mahasiswa Tugas Akhir': { 
                columns: [
                    {key:'Nama', label:'Nama'}, 
                    {key:'NPM', label:'NPM'}, 
                    {key:'Prodi', label:'Program Studi'}, 
                    {key:'StatusAkademik', label:'Status Akademik', render: (v) => (
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                            v === 'Aktif' ? 'bg-emerald-100 text-emerald-700' :
                            v === 'Cuti' ? 'bg-yellow-100 text-yellow-700' :
                            v === 'Limit DO' ? 'bg-red-100 text-red-700' :
                            'bg-gray-100 text-gray-700'
                        }`}>{v || 'Aktif'}</span>
                    )},
                    {key:'Pembimbing_1', label:'Pembimbing 1'}, 
                    {key:'Pembimbing_2', label:'Pembimbing 2'},
                    {key:'Status', label:'Tahapan', render: (v) => (
                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                            v === 'Lulus' ? 'bg-green-100 text-green-700' :
                            v === 'Sudah Sidang' ? 'bg-blue-100 text-blue-700' :
                            v === 'Sudah Hasil' ? 'bg-pink-100 text-pink-700' :
                            v === 'Sudah Proposal' ? 'bg-orange-100 text-orange-700' :
                            'bg-gray-100 text-gray-600'
                        }`}>{v}</span>
                    )},
                    {key:'BimbinganCount', label:'Bimbingan (x)', render: (v) => <span className="font-mono font-bold text-purple-700 bg-purple-100 px-2 py-0.5 rounded">{v || 0}</span>},
                    {key:'ProgresDeskripsi', label:'Ket. Progres', render: (v) => <span className="text-xs text-gray-600 italic truncate max-w-[150px] block">{v ? (v.length > 25 ? v.substring(0,25)+'...' : v) : '-'}</span>}
                ], 
                form: [] 
            },
            'Tugas Akhir Mahasiswa (Dosen)': {
                columns: [
                    {key:'Nama', label:'Nama'}, 
                    {key:'NPM', label:'NPM'}, 
                    {key:'Judul', label:'Judul'},
                    {key:'Status', label:'Tahapan', render: (v) => (
                        <span className={`px-2 py-1 rounded text-xs font-bold ${
                            v === 'Lulus' ? 'bg-green-100 text-green-700' :
                            v === 'Sudah Sidang' ? 'bg-blue-100 text-blue-700' :
                            v === 'Sudah Hasil' ? 'bg-pink-100 text-pink-700' :
                            v === 'Sudah Proposal' ? 'bg-orange-100 text-orange-700' :
                            'bg-gray-100 text-gray-600'
                        }`}>{v}</span>
                    )},
                    {key:'LinkLaporan', label:'Link Laporan', render: (v) => v ? <a href={v} target="_blank" className="text-blue-600 hover:underline flex items-center gap-1 font-bold text-xs"><Icon path={PATHS.ExternalLink} size={14}/> Buka Laporan</a> : <span className="text-gray-300 italic text-xs">Belum ada</span>}
                ],
                form: []
            },
            'Jadwal Ujian TA': {
                columns: [
                    {key:'Mahasiswa', label:'Mahasiswa'}, 
                    {key:'Jenis', label:'Jenis'}, 
                    {key:'Tanggal', label:'Tanggal', render: (v) => formatDateId(v)},
                    {key:'Jam', label:'Jam'}, 
                    {key:'Ruang', label:'Ruang'}
                ],
                form: [{key:'Mahasiswa', label:'Nama Mahasiswa'}, {key:'Jenis', label:'Jenis Ujian', type: 'select', options:[{value:'Seminar Proposal', label:'Sempro'}, {value:'Seminar Hasil', label:'Semhas'}, {value:'Sidang', label:'Sidang'}]}, {key:'Tanggal', label:'Tanggal', type:'date'}, {key:'Jam', label:'Jam'}, {key:'Ruang', label:'Ruangan'}]
            },
            'Data Unduhan': {
                columns: [
                    {key:'Judul', label:'Nama Berkas'},
                    {key:'Kategori', label:'Kategori'},
                    {key:'Link', label:'Link', render: (v) => <a href={v} target="_blank" className="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold hover:bg-green-200 transition flex items-center w-fit gap-1"><Icon path={PATHS.Download} size={14}/> Unduh</a>}
                ],
                form: [
                    {key:'Judul', label:'Nama Dokumen'},
                    {key:'Kategori', label:'Kategori', type: 'select', options:[{value:'Pedoman', label:'Pedoman'}, {value:'Template', label:'Template'}, {value:'SK', label:'SK'}, {value:'Materi', label:'Materi'}]},
                    {key:'Link', label:'Link Download (Google Drive)', placeholder: 'https://...'}
                ]
            },
            'Informasi': {
                columns: [
                    {key:'Judul', label:'Judul'}, 
                    {key:'Penulis', label:'Oleh'}, 
                    {key:'Tanggal', label:'Tanggal', render: (v) => formatDateId(v)},
                    {key:'Tipe', label:'Kategori', render: (v) => (
                        <span className={`px-2 py-1 rounded text-xs font-bold ${
                            v === 'Jadwal' ? 'bg-blue-100 text-blue-700' :
                            v === 'Akademik' ? 'bg-purple-100 text-purple-700' :
                            'bg-gray-100 text-gray-700'
                        }`}>{v}</span>
                    )}
                ],
                form: [
                    {key:'Judul', label:'Judul Pengumuman'},
                    {key:'Isi', label:'Isi Pengumuman', type: 'textarea'},
                    {key:'Tipe', label:'Kategori', type: 'select', options:[{value:'Umum', label:'Umum'}, {value:'Akademik', label:'Akademik'}, {value:'Jadwal', label:'Jadwal'}]},
                    {key:'Tanggal', label:'Tanggal', type:'date'}
                ]
            },
            'Pengajuan Judul': {
                columns: [{key:'Nama', label:'Nama'}, {key:'NPM', label:'NPM'}, {key:'Judul', label:'Usulan Judul'}, {key:'Peminatan', label:'Peminatan'}],
                form: [{key:'Nama', label:'Nama Lengkap'}, {key:'NPM', label:'NPM'}, {key:'Peminatan', label:'Peminatan', type: 'select', options:[]}, {key:'Judul', label:'Usulan Judul Penelitian'}, {key:'Masalah', label:'Rumusan Masalah Singkat', type:'text'}]
            },
            'Pendaftaran Sempro': { columns: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}], form: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}]},
            'Pendaftaran Semhas': { columns: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}], form: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}]},
            'Pendaftaran Sidang': { columns: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}], form: [{key:'Nama',label:'Nama'},{key:'Judul',label:'Judul'}]},
            'Layanan Surat': { columns: [{key:'Nama',label:'Nama'},{key:'Jenis_Surat',label:'Jenis'},{key:'Status',label:'Status'}], form: [{key:'Nama',label:'Nama'},{key:'Jenis_Surat',label:'Jenis'},{key:'Status',label:'Status',type:'select',options:[{value:'Diproses',label:'Diproses'},{value:'Selesai',label:'Selesai'}]}]},
            'Data Yudisium': { columns: [{key:'Nama',label:'Nama'},{key:'IPK',label:'IPK'}], form: [{key:'Nama',label:'Nama'},{key:'IPK',label:'IPK'}]},
            'Laporan TA': { columns: [{key:'Nama', label:'Nama'}, {key:'NPM', label:'NPM'}, {key:'Judul', label:'Judul Laporan'}, {key:'Link', label:'Link Dokumen', render: (v) => <a href={v} target="_blank" className="text-blue-600 hover:underline flex items-center gap-1"><Icon path={PATHS.ExternalLink} size={14}/> Buka</a>}], form: [{key:'Nama', label:'Nama'}, {key:'NPM', label:'NPM'}, {key:'Judul', label:'Judul Laporan'}, {key:'Link', label:'Link Dokumen (G Drive)'}]}
        };

        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                try { return JSON.parse(window.localStorage.getItem(key)) || defaultValue; } catch { return defaultValue; }
            });
            useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
            return [value, setValue];
        };

        const useDatabase = (initialData, scriptUrl) => {
            const [localData, setLocalData] = useStickyState(initialData, 'sim_tugasakhir_db_v10_progresbab'); 
            const [isOnline, setIsOnline] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [isBackgroundSyncing, setIsBackgroundSyncing] = useState(false);
            const [lastSyncTime, setLastSyncTime] = useState(null);

            const syncData = async (url, isBackground = false) => {
                if (!url) return;
                if (isBackground) setIsBackgroundSyncing(true); else setIsLoading(true);
                try {
                    const res = await fetch(`${url}?action=read`);
                    if (res.ok) {
                        const cloudData = await res.json();
                        if (!cloudData.error) {
                            setLocalData(prev => ({...prev, ...cloudData}));
                            setIsOnline(true);
                            setLastSyncTime(new Date());
                        }
                    } else setIsOnline(false);
                } catch (e) { setIsOnline(false); } 
                finally { if (isBackground) setIsBackgroundSyncing(false); else setIsLoading(false); }
            };

            useEffect(() => {
                if (scriptUrl && scriptUrl.startsWith('https://script.google.com')) {
                    syncData(scriptUrl, false);
                    const intervalId = setInterval(() => syncData(scriptUrl, true), 10000); 
                    return () => clearInterval(intervalId);
                } else setIsOnline(false);
            }, [scriptUrl]);

            const sendToCloud = async (action, collection, data) => {
                if(!scriptUrl) return;
                setIsBackgroundSyncing(true); 
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, collection, data })
                    });
                } catch(e) { console.error("Cloud Sync Error:", e); } 
                finally { setIsBackgroundSyncing(false); }
            };

            const crud = {
                add: (key, item) => {
                    const newItem = { id: Date.now(), ...item };
                    setLocalData(p => ({...p, [key]: [...(p[key]||[]), newItem]}));
                    sendToCloud('create', key, newItem);
                },
                del: (key, id) => {
                    setLocalData(p => ({...p, [key]: p[key].filter(x => x.id !== id)}));
                    sendToCloud('delete', key, { id });
                },
                update: (key, id, newItem) => {
                    setLocalData(p => ({...p, [key]: p[key].map(x => x.id === id ? {...x, ...newItem} : x)}));
                    sendToCloud('update', key, { id, ...newItem });
                },
                importBatch: (key, items) => {
                    const newItems = items.map(i => ({ id: Date.now() + Math.random(), ...i }));
                    setLocalData(p => ({...p, [key]: [...(p[key]||[]), ...newItems]}));
                    sendToCloud('batch', key, newItems);
                },
                batchUpdate: (updates) => {
                    setLocalData(p => ({...p, ...updates}));
                },
                save: sendToCloud
            };
            return { db: localData, ...crud, isOnline, isLoading, isBackgroundSyncing, lastSyncTime, refresh: () => scriptUrl && syncData(scriptUrl, false) };
        };

        // --- COMPONENTS ---
        const LoginCard = ({ isModal = false, db, handleRoleLogin, setShowLogin, onRefresh, isLoading }) => {
            const [loginRole, setLoginRole] = useState(null); 
            const [idInput, setIdInput] = useState('');
            const [passInput, setPassInput] = useState('');
            const [error, setError] = useState('');

            useEffect(() => { setIdInput(''); setPassInput(''); setError(''); }, [loginRole]);

            const attemptLogin = () => {
                setError('');
                const cleanId = idInput.trim();
                const cleanPass = passInput.trim();

                if (loginRole === 'admin') {
                    if (btoa(cleanPass) === AUTH_TOKEN) handleRoleLogin('admin'); else setError('Password Admin Salah!');
                } else if (loginRole === 'tendik') {
                    if (cleanId === '101090' && cleanPass === '101090') handleRoleLogin('tendik', { Nama: 'Staf Akademik (Tendik)', NIDN: '101090' }); else setError('ID atau Password Tendik Salah!');
                } else if (loginRole === 'mahasiswa') {
                    const user = (db['Mahasiswa Tugas Akhir'] || []).find(m => String(m.NPM).trim() === cleanId);
                    if (user && cleanPass === String(user.NPM).trim()) handleRoleLogin('mahasiswa', user); else setError('NPM tidak ditemukan atau Password salah (Gunakan NPM)');
                } else if (loginRole === 'dosen') {
                    const user = (db['Data Dosen'] || []).find(d => String(d.NIDN).trim() === cleanId);
                    if (user && cleanPass === String(user.NIDN).trim()) handleRoleLogin('dosen', user); else setError('NIDN tidak ditemukan atau Password salah (Gunakan NIDN)');
                }
            };

            const renderInputs = () => (
                <div className="space-y-4 animate-fade-in">
                    {loginRole !== 'admin' && (
                        <div>
                            <label className="text-xs font-bold text-purple-700 uppercase ml-1">{loginRole === 'mahasiswa' ? 'NPM' : loginRole === 'tendik' ? 'ID Tendik' : 'NIDN'}</label>
                            <input className="input-modern" placeholder={loginRole === 'mahasiswa' ? '2020...' : '123...'} value={idInput} onChange={e => setIdInput(e.target.value)} autoFocus />
                        </div>
                    )}
                    <div>
                        <label className="text-xs font-bold text-purple-700 uppercase ml-1">Password</label>
                        <input type="password" className="input-modern" placeholder="â€¢â€¢â€¢â€¢â€¢" value={passInput} onChange={e => setPassInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && attemptLogin()} />
                    </div>
                    {error && <div className="p-3 bg-red-100 text-red-600 text-sm rounded-xl font-bold text-center border border-red-200 animate-pulse">{error}</div>}
                    <button onClick={attemptLogin} className="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-bold shadow-lg shadow-purple-500/30 hover:shadow-xl transition transform active:scale-95">Masuk</button>
                    <button onClick={() => setLoginRole(null)} className="w-full py-2 text-purple-500 text-sm hover:underline">Kembali</button>
                </div>
            );

            return (
                <div className={`glass p-8 md:p-10 rounded-3xl w-full max-w-sm shadow-2xl border border-white/60 relative overflow-hidden ${isModal ? '' : 'animate-slide-up'}`}>
                    <div className="absolute -top-10 -right-10 w-32 h-32 bg-purple-300 rounded-full blur-3xl opacity-30"></div>
                    <div className="absolute -bottom-10 -left-10 w-32 h-32 bg-pink-300 rounded-full blur-3xl opacity-30"></div>
                    {!loginRole && (
                        <div onClick={() => setLoginRole('admin')} className="cursor-pointer w-20 h-20 bg-gradient-to-br from-purple-100 to-white rounded-2xl flex items-center justify-center mx-auto mb-6 text-purple-600 shadow-lg shadow-purple-500/10 rotate-3 hover:rotate-6 transition-all duration-300 hover:scale-110 active:scale-95 group" title="Klik untuk akses Admin">
                            <Icon path={PATHS.Lock} size={36} className="group-hover:text-purple-800 transition-colors"/>
                        </div>
                    )}
                    <h3 className="text-2xl font-bold mb-2 text-center text-purple-900">{isModal ? 'Ganti Akses' : (loginRole ? `Login ${loginRole.charAt(0).toUpperCase() + loginRole.slice(1)}` : 'Selamat Datang')}</h3>
                    {!loginRole && <p className="text-center text-purple-600/70 text-xs mb-8">SI Tugas Akhir Terintegrasi FIKPsi</p>}
                    {!loginRole ? (
                        <div className="space-y-3 mb-6">
                            <button onClick={()=>setLoginRole('mahasiswa')} className="group w-full py-3.5 bg-white/70 hover:bg-white border border-white rounded-xl text-purple-700 font-bold transition flex items-center justify-center gap-3 shadow-sm hover:shadow-md hover:scale-[1.02]">
                                <span className="p-1 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition"><Icon path={PATHS.Graduation} size={18}/></span> Mahasiswa
                            </button>
                            <button onClick={()=>setLoginRole('dosen')} className="group w-full py-3.5 bg-white/70 hover:bg-white border border-white rounded-xl text-purple-700 font-bold transition flex items-center justify-center gap-3 shadow-sm hover:shadow-md hover:scale-[1.02]">
                                <span className="p-1 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition"><Icon path={PATHS.Users} size={18}/></span> Dosen
                            </button>
                            <button onClick={()=>setLoginRole('tendik')} className="group w-full py-3.5 bg-white/70 hover:bg-white border border-white rounded-xl text-purple-700 font-bold transition flex items-center justify-center gap-3 shadow-sm hover:shadow-md hover:scale-[1.02]">
                                <span className="p-1 bg-purple-100 rounded-lg group-hover:bg-purple-200 transition"><Icon path={PATHS.Cog} size={18}/></span> Tenaga Kependidikan
                            </button>
                        </div>
                    ) : renderInputs()}
                    {isModal && <button onClick={()=>setShowLogin(false)} className="absolute top-4 right-4 text-purple-300 hover:text-purple-600 transition"><Icon path={PATHS.X} size={20}/></button>}
                </div>
            );
        };

        const NotificationPopup = ({ data, onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/20 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                <div className="glass bg-white p-6 rounded-3xl max-w-sm w-full shadow-2xl relative border-2 border-white/50 animate-pop-in" onClick={e=>e.stopPropagation()}>
                    <div className="absolute -top-12 left-1/2 transform -translate-x-1/2 w-24 h-24 bg-gradient-to-tr from-yellow-300 to-orange-400 rounded-full flex items-center justify-center border-4 border-white shadow-lg animate-blob">
                        <span className="text-4xl animate-bounce-slight">ðŸ””</span>
                    </div>
                    <button onClick={onClose} className="absolute top-4 right-4 text-purple-300 hover:text-purple-600 transition"><Icon path={PATHS.X}/></button>
                    <div className="mt-10 text-center">
                        <h4 className="text-xl font-bold text-purple-900 mb-2">Halo, {data.user}!</h4>
                        <p className="text-xs font-bold text-pink-500 uppercase tracking-widest mb-4">{data.type}</p>
                        <div className="bg-purple-50 p-4 rounded-2xl border border-purple-100 text-sm text-gray-600 mb-6">
                            <p className="font-bold text-purple-800 mb-1">{data.title}</p>
                            <p>{data.message}</p>
                        </div>
                        <button onClick={onClose} className="bg-gradient-to-r from-purple-600 to-pink-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-purple-500/40 hover:scale-105 transition transform active:scale-95">Oke, Mengerti!</button>
                    </div>
                </div>
            </div>
        );

        // --- NEW BIMBINGAN COMPONENTS ---

        const StatusBadge = ({ status }) => {
            const styles = {
                approved: 'bg-green-100 text-green-700 border-green-200',
                revision: 'bg-orange-100 text-orange-700 border-orange-200',
                pending: 'bg-blue-50 text-blue-700 border-blue-100',
                locked: 'bg-slate-100 text-slate-500 border-slate-200',
                completed: 'bg-green-100 text-green-700 border-green-200'
            };
            const labels = {
                approved: 'Disetujui',
                revision: 'Revisi',
                pending: 'Menunggu',
                locked: 'Terkunci',
                completed: 'Selesai'
            };
            return (
                <span className={`px-2.5 py-1 rounded-md text-xs font-semibold border ${styles[status] || styles.locked}`}>
                    {labels[status] || status}
                </span>
            );
        };

        const GuidanceRoom = ({ currentUser, chats, onSend, userRole, db }) => {
            const [activeAdvisor, setActiveAdvisor] = useState(userRole === 'mahasiswa' ? currentUser.Pembimbing_1 : null);
            const [newMessage, setNewMessage] = useState('');
            const chatEndRef = useRef(null);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chats, activeAdvisor]);

            const [activeStudentName, setActiveStudentName] = useState(null);

            const filteredChats = chats.filter(msg => {
                if (userRole === 'mahasiswa') {
                    return (msg.sender === currentUser.Nama && msg.receiver === activeAdvisor) ||
                           (msg.sender === activeAdvisor && msg.receiver === currentUser.Nama);
                } else {
                    if (!activeStudentName) return false;
                    return (msg.sender === currentUser.Nama && msg.receiver === activeStudentName) ||
                           (msg.sender === activeStudentName && msg.receiver === currentUser.Nama);
                }
            });

            const myStudents = useMemo(() => {
                if (userRole !== 'dosen') return [];
                return (db['Mahasiswa Tugas Akhir'] || []).filter(m =>   
                    m.Pembimbing_1 === currentUser.Nama || m.Pembimbing_2 === currentUser.Nama
                );
            }, [db, currentUser]);

            const handleSendMsg = (e) => {
                e.preventDefault();
                if (!newMessage.trim()) return;
                const receiver = userRole === 'mahasiswa' ? activeAdvisor : activeStudentName;
                if (!receiver) return alert("Pilih lawan bicara dulu.");

                onSend({
                    sender: currentUser.Nama,
                    receiver: receiver,
                    message: newMessage,
                    type: 'text'
                });
                setNewMessage('');
            };

            return (
                <div className="flex flex-col h-[calc(100vh-200px)] bg-white rounded-3xl border border-purple-100 shadow-xl overflow-hidden animate-slide-up">
                    <div className="border-b border-purple-50 bg-purple-50/50">
                        {userRole === 'mahasiswa' ? (
                            <div className="flex p-3 gap-2">
                                <button onClick={() => setActiveAdvisor(currentUser.Pembimbing_1)} className={`flex-1 py-2 px-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeAdvisor === currentUser.Pembimbing_1 ? 'bg-white text-purple-700 shadow-sm text-purple-600' : 'text-gray-400 hover:bg-white/50'}`}>
                                    <div className={`w-2 h-2 rounded-full ${activeAdvisor === currentUser.Pembimbing_1 ? 'bg-purple-500' : 'bg-gray-300'}`}></div> P1: {currentUser.Pembimbing_1}
                                </button>
                                <button onClick={() => setActiveAdvisor(currentUser.Pembimbing_2)} className={`flex-1 py-2 px-3 rounded-xl text-sm font-bold transition-all flex items-center justify-center gap-2 ${activeAdvisor === currentUser.Pembimbing_2 ? 'bg-white text-purple-700 shadow-sm text-purple-600' : 'text-gray-400 hover:bg-white/50'}`}>
                                    <div className={`w-2 h-2 rounded-full ${activeAdvisor === currentUser.Pembimbing_2 ? 'bg-purple-500' : 'bg-gray-300'}`}></div> P2: {currentUser.Pembimbing_2}
                                </button>
                            </div>
                        ) : (
                            <div className="p-3">
                                <select className="input-modern" onChange={(e) => setActiveStudentName(e.target.value)} value={activeStudentName || ''}>
                                    <option value="">Pilih Mahasiswa Bimbingan...</option>
                                    {myStudents.map(s => <option key={s.id} value={s.Nama}>{s.Nama} ({s.NPM})</option>)}
                                </select>
                            </div>
                        )}
                        <div className="px-4 pb-3 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-200 to-pink-200 flex items-center justify-center text-purple-700 font-bold border-2 border-white">
                                    {(userRole === 'mahasiswa' ? (activeAdvisor || '?') : (activeStudentName || '?')).charAt(0)}
                                </div>
                                <div>
                                    <h3 className="font-bold text-purple-900 text-sm">{userRole === 'mahasiswa' ? activeAdvisor : activeStudentName || 'Pilih Mahasiswa'}</h3>
                                    <p className="text-[10px] text-gray-500 flex items-center gap-1">Online</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50/30">
                        {filteredChats.length === 0 ? (
                            <div className="h-full flex flex-col items-center justify-center text-gray-300 opacity-60">
                                <Icon path={PATHS.MessageSquare} size={48} className="mb-2"/>
                                <p className="text-xs">Belum ada percakapan.</p>
                            </div>
                        ) : (
                            filteredChats.map((chat) => {
                                const isMe = chat.sender === currentUser.Nama;
                                return (
                                    <div key={chat.id} className={`flex ${isMe ? 'justify-end' : 'justify-start'} animate-fade-in`}>
                                        <div className={`max-w-[85%] md:max-w-[70%] flex flex-col ${isMe ? 'items-end' : 'items-start'}`}>
                                            <div className={`p-3.5 rounded-2xl text-sm leading-relaxed shadow-sm ${isMe ? 'bg-purple-600 text-white rounded-br-none' : 'bg-white border border-purple-100 text-gray-700 rounded-bl-none'}`}>
                                                <p>{chat.message}</p>
                                            </div>
                                            <span className="text-[10px] text-gray-400 mt-1 px-1 flex items-center gap-1">
                                                {formatDateId(chat.timestamp, true)}
                                            </span>
                                        </div>
                                    </div>
                                );
                            })
                        )}
                        <div ref={chatEndRef} />
                    </div>

                    <div className="p-4 bg-white border-t border-purple-50">
                        <form onSubmit={handleSendMsg} className="flex gap-2 items-end">
                            <div className="flex-1 bg-gray-50 rounded-xl px-4 py-2 border border-transparent focus-within:border-purple-200 focus-within:bg-white transition-all">
                                <input type="text" value={newMessage} onChange={(e) => setNewMessage(e.target.value)} placeholder="Tulis pesan..." className="w-full bg-transparent outline-none text-sm"/>
                            </div>
                            <button type="submit" disabled={!newMessage.trim()} className="p-3 rounded-xl bg-purple-600 text-white hover:bg-purple-700 shadow-md transition disabled:opacity-50"><Icon path={PATHS.Send}/></button>
                        </form>
                    </div>
                </div>
            );
        };

        const ScheduleManager = ({ currentUser, schedules, onAdd, onUpdate, userRole, db }) => {
            const [formData, setFormData] = useState({ date: '', time: '', topic: '', advisorName: '' });

            const mySchedules = schedules.filter(s => {
                if (userRole === 'mahasiswa') return s.studentName === currentUser.Nama;
                return s.advisorName === currentUser.Nama;
            });

            const handleRequest = (e) => {
                e.preventDefault();
                if (!formData.advisorName) return alert("Pilih Dosen");
                onAdd({ ...formData, studentName: currentUser.Nama, status: 'pending' });
                setFormData({ date: '', time: '', topic: '', advisorName: '' });
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-fade-in">
                    <div className="space-y-6">
                        <div>
                            <h2 className="text-xl font-bold text-purple-900">Manajemen Jadwal</h2>
                            <p className="text-sm text-gray-500">Ajukan dan kelola bimbingan tugas akhir.</p>
                        </div>

                        {userRole === 'mahasiswa' && (
                            <form onSubmit={handleRequest} className="glass p-6 rounded-3xl border border-white/60 shadow-lg space-y-4">
                                <h3 className="font-bold text-purple-800 text-sm border-b border-purple-100 pb-2">Ajukan Jadwal Baru</h3>
                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Pilih Dosen</label>
                                    <div className="grid grid-cols-2 gap-3">
                                        {[currentUser.Pembimbing_1, currentUser.Pembimbing_2].filter(p => p && p !== '-').map(adv => (
                                            <label key={adv} className={`cursor-pointer border p-3 rounded-xl flex items-center gap-2 transition-all ${formData.advisorName === adv ? 'border-purple-500 bg-purple-50 ring-1 ring-purple-500' : 'border-gray-200 hover:border-gray-300'}`}>
                                                <input type="radio" name="advisor" className="hidden" checked={formData.advisorName === adv} onChange={() => setFormData({...formData, advisorName: adv})} />
                                                <div className={`w-3 h-3 rounded-full border flex items-center justify-center ${formData.advisorName === adv ? 'border-purple-600 bg-purple-600' : 'border-gray-400'}`}></div>
                                                <span className="text-xs font-bold text-gray-700">{adv}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Tanggal</label><input required type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="input-modern py-2 text-xs" /></div>
                                    <div><label className="text-xs font-bold text-gray-500 block mb-1">Jam</label><input required type="time" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} className="input-modern py-2 text-xs" /></div>
                                </div>
                                <div><label className="text-xs font-bold text-gray-500 block mb-1">Topik</label><input required type="text" placeholder="Revisi Bab..." value={formData.topic} onChange={e => setFormData({...formData, topic: e.target.value})} className="input-modern py-2 text-xs" /></div>
                                <button type="submit" className="w-full bg-purple-600 text-white py-2.5 rounded-xl font-bold text-sm shadow-md hover:bg-purple-700 transition">Ajukan Jadwal</button>
                            </form>
                        )}
                        
                        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex gap-3 items-start">
                            <Icon path={PATHS.Info} className="text-blue-600 mt-0.5" />
                            <div className="text-xs text-blue-800 leading-relaxed"><span className="font-bold">Info:</span> Minimal 8x bimbingan sebelum sidang.</div>
                        </div>
                    </div>

                    <div className="glass rounded-3xl border border-white/60 shadow-lg overflow-hidden flex flex-col h-full min-h-[400px]">
                        <div className="p-5 border-b border-purple-100 bg-purple-50/30"><h3 className="font-bold text-purple-900">Daftar Jadwal</h3></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                            {mySchedules.length === 0 ? (
                                <div className="text-center py-10 text-gray-400 text-sm">Belum ada jadwal.</div>
                            ) : (
                                mySchedules.map(item => (
                                    <div key={item.id} className="p-4 bg-white border border-gray-100 rounded-2xl shadow-sm hover:shadow-md transition">
                                        <div className="flex justify-between items-start">
                                            <div className="flex gap-4">
                                                <div className={`w-12 h-12 rounded-xl flex flex-col items-center justify-center border ${item.status === 'approved' ? 'bg-green-50 border-green-200 text-green-700' : item.status === 'pending' ? 'bg-orange-50 border-orange-200 text-orange-700' : 'bg-gray-50 border-gray-200 text-gray-500'}`}>
                                                    <span className="text-[10px] font-bold uppercase">{new Date(item.date).toLocaleString('default', { month: 'short' })}</span>
                                                    <span className="text-lg font-bold leading-none">{new Date(item.date).getDate()}</span>
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-gray-800 text-sm">{item.topic}</h4>
                                                    <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                                        <Icon path={PATHS.Clock} size={12} /> {item.time} 
                                                        <span className="w-1 h-1 rounded-full bg-gray-300"></span>
                                                        {userRole === 'mahasiswa' ? item.advisorName : item.studentName}
                                                    </div>
                                                    <div className="mt-1"><StatusBadge status={item.status} /></div>
                                                </div>
                                            </div>
                                            {userRole === 'dosen' && item.status === 'pending' && (
                                                <div className="flex flex-col gap-1">
                                                    <button onClick={() => onUpdate('BimbinganJadwal', item.id, { status: 'approved' })} className="p-1.5 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"><Icon path={PATHS.CheckCircle} size={16}/></button>
                                                    <button onClick={() => onUpdate('BimbinganJadwal', item.id, { status: 'rejected' })} className="p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200"><Icon path={PATHS.X} size={16}/></button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW PROGRES COMPONENT FOR LECTURER ---
        const LecturerProgressDashboard = ({ currentUser, db }) => {
            const myStudents = useMemo(() => {
                if (!currentUser?.Nama) return [];
                const myName = String(currentUser.Nama).trim().toLowerCase();
                return (db['Mahasiswa Tugas Akhir'] || []).filter(m => {
                    const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                    const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                    return p1 === myName || p2 === myName;
                });
            }, [db, currentUser]);

            const getProgressColor = (bab) => {
                if (!bab) return 'bg-gray-100 text-gray-500';
                if (bab.includes('Bab')) {
                    const num = parseInt(bab.replace(/\D/g,''));
                    if (num === 6) return 'bg-green-100 text-green-700';
                    if (num >= 4) return 'bg-blue-100 text-blue-700';
                    if (num >= 2) return 'bg-purple-100 text-purple-700';
                }
                return 'bg-orange-100 text-orange-700';
            };

            if (myStudents.length === 0) {
                return (
                    <div className="glass p-8 rounded-3xl text-center text-gray-400 animate-fade-in">
                        <Icon path={PATHS.Users} size={48} className="mx-auto mb-2 opacity-50"/>
                        <p>Belum ada mahasiswa bimbingan.</p>
                    </div>
                )
            }

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-purple-900">Progres Mahasiswa</h2>
                            <p className="text-sm text-gray-500">Monitoring terkini laporan penulisan tugas akhir mahasiswa bimbingan.</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 gap-4">
                        {myStudents.map((student, idx) => (
                            <div key={student.id} className="glass p-5 rounded-3xl border border-white/60 shadow-lg hover:shadow-xl transition group">
                                <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                                    <div className="flex items-start gap-4 flex-1">
                                        <div className="w-12 h-12 rounded-full bg-gradient-to-tr from-purple-200 to-pink-200 flex items-center justify-center text-purple-700 font-bold border-2 border-white shadow-sm text-lg">
                                            {student.Nama.charAt(0)}
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="font-bold text-purple-900 text-lg leading-tight">{student.Nama}</h3>
                                            <p className="text-xs text-gray-500 font-medium">{student.NPM} â€¢ {student.Prodi}</p>
                                            
                                            <div className="mt-3 flex flex-wrap gap-2 items-center">
                                                <span className={`px-2.5 py-1 rounded-lg text-xs font-bold ${getProgressColor(student.ProgresBab)}`}>
                                                    {student.ProgresBab || 'Belum Lapor'}
                                                </span>
                                                <span className="text-xs text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100">
                                                   {student.BimbinganCount || 0}x Bimbingan
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="md:w-1/3 bg-white/50 p-3 rounded-xl border border-white">
                                        <div className="text-[10px] font-bold text-purple-400 uppercase mb-1">Status Tahap</div>
                                        <div className="text-sm font-bold text-purple-900 mb-2">{student.Status}</div>
                                        
                                        <div className="text-[10px] font-bold text-purple-400 uppercase mb-1">Update Terakhir</div>
                                        <div className="text-xs text-gray-600">
                                            {student.LastUpdateProgres 
                                                ? formatDateId(student.LastUpdateProgres, true)
                                                : '-'
                                            }
                                        </div>
                                        
                                        {student.ProgresDeskripsi && (
                                            <div className="mt-2 pt-2 border-t border-gray-100">
                                                <div className="text-[10px] text-gray-400 italic">"{student.ProgresDeskripsi.length > 40 ? student.ProgresDeskripsi.substring(0,40)+'...' : student.ProgresDeskripsi}"</div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const BimbinganPage = ({ currentUser, userRole, db, add, update }) => {
            const [activeTab, setActiveTab] = useState('dashboard');
            
            const progressData = useMemo(() => {
                const stages = ['Belum Proposal', 'Sudah Proposal', 'Sudah Hasil', 'Sudah Sidang', 'Lulus'];
                let currentStatus = 'Belum Proposal';
                if(userRole === 'mahasiswa') currentStatus = currentUser.Status;
                
                const currentIdx = stages.indexOf(currentStatus);
                return stages.map((stage, idx) => ({
                    chapter: stage,
                    status: idx < currentIdx ? 'approved' : (idx === currentIdx ? 'revision' : 'locked'),
                    progress: idx < currentIdx ? 100 : (idx === currentIdx ? 50 : 0)
                }));
            }, [currentUser, userRole]);

            return (
                <div className="space-y-6 pb-20 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                        <div>
                            <h2 className="text-3xl font-bold text-purple-900">Bimbingan Tugas Akhir</h2>
                            <p className="text-purple-600">Pantau progres, diskusi revisi, dan atur jadwal.</p>
                        </div>
                        <div className="flex bg-white/50 p-1 rounded-xl border border-white/60 shadow-sm">
                            {/* Lecturer gets Progres Tab instead of Dokumen */}
                            {userRole === 'dosen' ? (
                                ['dashboard', 'chat', 'jadwal', 'progres'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === tab ? 'bg-purple-600 text-white shadow-md' : 'text-purple-600 hover:bg-purple-100'}`}>
                                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))
                            ) : (
                                ['dashboard', 'chat', 'jadwal', 'dokumen'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${activeTab === tab ? 'bg-purple-600 text-white shadow-md' : 'text-purple-600 hover:bg-purple-100'}`}>
                                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))
                            )}
                        </div>
                    </div>

                    {activeTab === 'dashboard' && (
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-2 glass p-6 rounded-3xl border border-white/60 shadow-lg">
                                <h3 className="font-bold text-purple-900 mb-4">Timeline Pengerjaan</h3>
                                <div className="space-y-4">
                                    {progressData.map((item, idx) => (
                                        <div key={idx} className="flex items-center gap-4">
                                            <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${item.status === 'approved' ? 'bg-green-100 text-green-600' : item.status === 'revision' ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-400'}`}>
                                                {item.status === 'approved' ? <Icon path={PATHS.CheckCircle} size={16}/> : <span className="text-xs font-bold">{idx + 1}</span>}
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between mb-1">
                                                    <span className="text-sm font-bold text-gray-700">{item.chapter}</span>
                                                    <StatusBadge status={item.status} />
                                                </div>
                                                <div className="w-full bg-gray-100 rounded-full h-2">
                                                    <div className={`h-2 rounded-full ${item.status === 'approved' ? 'bg-green-500' : 'bg-orange-400'}`} style={{ width: `${item.progress}%` }}></div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="glass p-6 rounded-3xl border border-white/60 shadow-lg flex flex-col justify-center items-center text-center">
                                <div className="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 mb-4"><Icon path={PATHS.FileText} size={40}/></div>
                                <h3 className="font-bold text-purple-900 text-lg">Status Terkini</h3>
                                <p className="text-xs text-gray-500 mb-4">Update terakhir: {formatDateId(new Date())}</p>
                                <button className="px-6 py-2 bg-purple-600 text-white rounded-xl text-sm font-bold hover:bg-purple-700 transition">Lihat Detail</button>
                            </div>
                        </div>
                    )}

                    {activeTab === 'chat' && (
                        <GuidanceRoom   
                            currentUser={currentUser}   
                            userRole={userRole}   
                            db={db}
                            chats={db['BimbinganChats'] || []}   
                            onSend={(msg) => { add('BimbinganChats', { ...msg, timestamp: new Date().toISOString() }); }}   
                        />
                    )}

                    {activeTab === 'jadwal' && (
                        <ScheduleManager   
                            currentUser={currentUser}   
                            userRole={userRole}   
                            db={db}
                            schedules={db['BimbinganJadwal'] || []}   
                            onAdd={(data) => add('BimbinganJadwal', data)}   
                            onUpdate={(col, id, data) => update(col, id, data)}
                        />
                    )}

                    {activeTab === 'dokumen' && userRole === 'mahasiswa' && (
                        <div className="glass p-8 rounded-3xl text-center text-gray-400">
                            <Icon path={PATHS.Cloud} size={48} className="mx-auto mb-2 opacity-50"/>
                            <p>Fitur repositori dokumen sedang dalam pengembangan.</p>
                        </div>
                    )}

                    {/* --- NEW TAB FOR LECTURER --- */}
                    {activeTab === 'progres' && userRole === 'dosen' && (
                        <LecturerProgressDashboard 
                            currentUser={currentUser} 
                            db={db} 
                        />
                    )}
                </div>
            );
        };

        const GenericTable = ({ title, data, columns, formConfig, onAdd, onDel, onUpdate, onImport, allowAdd, allowDelete, allowEdit, allowImport, customFilters, statusFilterConfig, gformUrl, onBack }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [form, setForm] = useState({});
            const [search, setSearch] = useState("");
            const [filterValues, setFilterValues] = useState({});
            const [activeStatus, setActiveStatus] = useState(null); 
            const [detailItem, setDetailItem] = useState(null);
            const [isEditing, setIsEditing] = useState(false);
            const [editForm, setEditForm] = useState({});
            const [showImport, setShowImport] = useState(false);

            useEffect(() => { setActiveStatus(null); }, [statusFilterConfig ? statusFilterConfig.key : null]);

            const safeData = data || []; 

            const filtered = safeData.filter(d => {
                const matchesSearch = Object.values(d).some(v => String(v).toLowerCase().includes(search.toLowerCase()));
                let matchesFilters = true;
                if (customFilters) matchesFilters = customFilters.every(f => !filterValues[f.key] || d[f.key] === filterValues[f.key]);
                let matchesStatus = true;
                if (statusFilterConfig && activeStatus) matchesStatus = String(d[statusFilterConfig.key]).toLowerCase().trim() === String(activeStatus).toLowerCase().trim();
                return matchesSearch && matchesFilters && matchesStatus;
            }).sort((a, b) => (a.Nama || '').localeCompare(b.Nama || ''));

            const handleTemplateDownload = () => {
                const headers = formConfig.map(f => f.key);
                const sampleRow = formConfig.map(f => `Contoh ${f.label}`);
                const ws = XLSX.utils.aoa_to_sheet([headers, sampleRow]);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, `Template_${title.replace(/\s+/g, '_')}.xlsx`);
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const wb = XLSX.read(evt.target.result, { type: 'binary' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(ws);
                    if (confirm(`Import ${data.length} data?`)) {
                        onImport(data);
                        setShowImport(false);
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="flex flex-col md:flex-row justify-between gap-4 items-center">
                        <div className="flex items-center gap-3 w-full md:w-auto">
                            {onBack && <button onClick={onBack} className="p-3 bg-white/60 rounded-xl hover:bg-white transition shadow-sm text-purple-600 border border-white"><Icon path={PATHS.ArrowLeft} size={20}/></button>}
                            <h2 className="text-2xl font-bold text-purple-900 flex items-center gap-3"><span className="w-2 h-8 bg-gradient-to-b from-purple-500 to-pink-500 rounded-full shadow-lg shadow-purple-500/30"></span> {title}</h2>
                        </div>
                        <div className="flex flex-wrap gap-2 w-full md:w-auto items-center justify-end">
                            {allowImport && (
                                <div className="relative">
                                    <button onClick={()=>setShowImport(!showImport)} className={`px-4 py-2.5 rounded-xl font-bold text-sm transition shadow-lg flex items-center gap-2 transform active:scale-95 ${showImport ? 'bg-purple-100 text-purple-700' : 'bg-white text-purple-600 border border-purple-100 hover:bg-purple-50'}`}><Icon path={PATHS.FileUp} size={18}/> Import</button>
                                    {showImport && (
                                        <div className="absolute right-0 top-full mt-2 bg-white p-4 rounded-xl shadow-2xl z-50 w-64 border border-purple-100 animate-slide-up">
                                            <button onClick={handleTemplateDownload} className="w-full text-left px-3 py-2.5 text-xs font-bold text-purple-600 hover:bg-purple-50 rounded-lg mb-2 flex items-center gap-2"><Icon path={PATHS.Download} size={14}/> 1. Unduh Template</button>
                                            <div className="relative group">
                                                <input type="file" accept=".xlsx, .xls" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"/>
                                                <button className="w-full text-left px-3 py-2.5 text-xs font-bold text-white bg-gradient-to-r from-green-500 to-emerald-600 hover:shadow-lg rounded-lg flex items-center gap-2"><Icon path={PATHS.FileUp} size={14}/> 2. Upload Excel</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                            <div className="relative flex-grow md:flex-grow-0 group">
                                <Icon path={PATHS.Search} className="absolute left-3 top-3 text-purple-400 group-focus-within:text-purple-600 transition-colors" size={18}/>
                                <input className="input-modern pl-10 py-2.5 text-sm w-full md:w-48 shadow-sm" placeholder="Cari data..." value={search} onChange={e=>setSearch(e.target.value)}/>
                            </div>
                            {allowAdd && (
                                <button onClick={()=>setIsOpen(!isOpen)} className={`px-5 py-2.5 rounded-xl font-semibold text-sm transition shadow-lg flex items-center gap-2 transform active:scale-95 ${isOpen ? 'bg-red-50 text-red-500 border border-red-200' : 'bg-gradient-to-r from-pink-500 to-purple-600 text-white hover:shadow-purple-500/30'}`}><Icon path={isOpen ? PATHS.X : PATHS.Plus} size={18}/> {isOpen ? 'Batal' : 'Tambah'}</button>
                            )}
                        </div>
                    </div>

                    {statusFilterConfig && (
                        <div className="flex flex-wrap gap-2 animate-fade-in mb-2">
                            <button type="button" onClick={() => setActiveStatus(null)} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all duration-300 border ${!activeStatus ? 'bg-purple-600 text-white border-purple-600 shadow-md transform scale-105' : 'bg-white text-gray-500 border-gray-200 hover:border-purple-300 hover:text-purple-600'}`}>Semua</button>
                            {statusFilterConfig.options.map(opt => (
                                <button type="button" key={opt} onClick={() => setActiveStatus(opt)} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all duration-300 border ${activeStatus === opt ? 'bg-purple-600 text-white border-purple-600 shadow-md transform scale-105' : 'bg-white text-gray-500 border-gray-200 hover:border-purple-300 hover:text-purple-600'}`}>{opt}</button>
                            ))}
                        </div>
                    )}

                    {isOpen && allowAdd && (
                        <form onSubmit={(e)=>{e.preventDefault(); onAdd(form); setForm({}); setIsOpen(false); }} className="glass p-6 md:p-8 rounded-3xl grid md:grid-cols-2 gap-6 shadow-xl border border-white/60 animate-slide-up relative z-10">
                            {formConfig.map(f => (
                                <div key={f.key} className={f.type === 'textarea' ? 'md:col-span-2' : ''}>
                                    <label className="text-xs font-bold text-purple-800/70 uppercase ml-1 mb-2 block tracking-wide">{f.label}</label>
                                    {f.type==='select' ? (
                                        <div className="relative">
                                            <select className="input-modern cursor-pointer appearance-none" value={form[f.key]||''} onChange={e=>setForm({...form,[f.key]:e.target.value})}>
                                                <option value="">Pilih...</option>{f.options.map(o=><option key={o.value} value={o.value}>{o.label}</option>)}
                                            </select>
                                            <Icon path={PATHS.ChevronDown} className="absolute right-3 top-3 text-purple-400 pointer-events-none" size={16}/>
                                        </div>
                                    ) : f.type === 'textarea' ? (
                                        <textarea className="textarea-modern" value={form[f.key]||''} onChange={e=>setForm({...form,[f.key]:e.target.value})} placeholder={f.placeholder || ''} required/>
                                    ) : (
                                        <input className="input-modern" type={f.type||'text'} value={form[f.key]||''} onChange={e=>setForm({...form,[f.key]:e.target.value})} placeholder={f.placeholder || ''} required/>
                                    )}
                                </div>
                            ))}
                            <button type="submit" className="md:col-span-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3.5 rounded-xl font-bold mt-4 hover:shadow-xl hover:shadow-purple-500/30 transition transform hover:-translate-y-0.5 active:translate-y-0">Simpan Data</button>
                        </form>
                    )}

                    <div className="glass rounded-3xl overflow-hidden shadow-lg border border-white/60 overflow-x-auto relative z-0">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-purple-50/80 backdrop-blur-md text-purple-900/70 font-bold uppercase text-xs border-b border-purple-100">
                                <tr>{columns.map(c=><th key={c.key} className="px-6 py-5 whitespace-nowrap">{c.label}</th>)}{allowDelete && <th className="px-6 py-5 text-center">Aksi</th>}</tr>
                            </thead>
                            <tbody className="divide-y divide-purple-50">
                                {filtered.map((row, idx)=>(
                                    <tr key={row.id} className="hover:bg-purple-50/60 transition duration-150 group" style={{animationDelay: `${idx*50}ms`}}>
                                        {columns.map(c=><td key={c.key} className="px-6 py-4 text-purple-900 font-medium whitespace-nowrap">{(c.key === 'Nama' || c.key === 'Mahasiswa' || c.key === 'Judul') ? <button onClick={() => {setDetailItem(row); setIsEditing(false);}} className="flex items-center gap-2 font-bold hover:text-pink-600 transition-colors text-left"><div className="w-8 h-8 rounded-full bg-gradient-to-tr from-purple-200 to-pink-200 flex items-center justify-center text-purple-700 text-xs shadow-inner">{row[c.key].substring(0,2).toUpperCase()}</div><span className="truncate max-w-[200px] block">{row[c.key]}</span></button> : (c.render ? c.render(row[c.key], row) : row[c.key])}</td>)}
                                        {allowDelete && <td className="px-6 py-4 text-center"><button onClick={()=>onDel(row.id)} className="text-red-300 hover:text-red-600 bg-red-50/0 hover:bg-red-50 p-2 rounded-lg transition"><Icon path={PATHS.Trash}/></button></td>}
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {filtered.length===0 && <div className="p-12 text-center flex flex-col items-center gap-4 text-purple-300"><Icon path={PATHS.Search} size={48} className="opacity-20"/><span className="font-medium">Belum ada data ditemukan</span></div>}
                    </div>

                    {/* --- DETAIL MODAL --- */}
                    {detailItem && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-purple-900/20 backdrop-blur-sm p-4 animate-fade-in" onClick={() => setDetailItem(null)}>
                            <div className="glass bg-white p-6 md:p-8 rounded-3xl w-full max-w-lg shadow-2xl border border-white/60 relative overflow-y-auto max-h-[90vh] animate-slide-up" onClick={e => e.stopPropagation()}>
                                <button onClick={() => setDetailItem(null)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 bg-white/50 rounded-full p-2 hover:bg-white transition"><Icon path={PATHS.X} size={20}/></button>
                                <h3 className="text-2xl font-bold text-purple-900 mb-6 border-b border-purple-100 pb-2 flex items-center gap-3">
                                    <Icon path={PATHS.Info} className="text-purple-500"/> {isEditing ? 'Edit Data' : 'Detail Data'}
                                </h3>
                                {!isEditing ? (
                                    <div className="space-y-4">
                                        {Object.entries(detailItem).map(([key, value]) => {
                                            if (key === 'id') return null;
                                            
                                            const labelMap = {
                                                BimbinganCount: 'Jumlah Bimbingan',
                                                ProgresDeskripsi: 'Detail Progres',
                                                LastUpdateProgres: 'Waktu Lapor Progres',
                                                StatusAkademik: 'Status Akademik',
                                                Pembimbing_1: 'Pembimbing 1',
                                                Pembimbing_2: 'Pembimbing 2',
                                                Jenis_Surat: 'Jenis Surat',
                                                LinkLaporan: 'Link Laporan (G Drive)',
                                                ProgresBab: 'Sedang Mengerjakan'
                                            };
                                            const displayLabel = labelMap[key] || key.replace(/_/g, ' ');

                                            let displayValue = value;
                                            if (key === 'LastUpdateProgres' && value) {
                                                displayValue = formatDateId(value, true); 
                                            }
                                            if (key === 'ProgresBab' && value) {
                                                // Special styling for progress bab
                                                displayValue = <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs font-bold border border-purple-200">{value}</span>;
                                            }
                                            if (value === 0) displayValue = "0";

                                            return (
                                                <div key={key} className="grid grid-cols-1 md:grid-cols-3 gap-1 md:gap-4 border-b border-purple-50 pb-2 last:border-0">
                                                    <div className="text-xs font-bold text-purple-400 uppercase tracking-wider pt-1">{displayLabel}</div>
                                                    <div className="md:col-span-2 text-gray-800 font-medium text-sm break-words whitespace-pre-wrap">
                                                        {(typeof displayValue === 'string' && displayValue.startsWith('http')) ?   
                                                            <a href={displayValue} target="_blank" className="text-blue-600 hover:underline flex items-center gap-1"><Icon path={PATHS.ExternalLink} size={14}/> Buka Link</a> : (displayValue || "-")}
                                                    </div>
                                                </div>
                                            )
                                        })}
                                        {allowEdit && (
                                            <div className="mt-6 pt-4 border-t border-purple-100 flex justify-end">
                                                <button onClick={() => { setEditForm(detailItem); setIsEditing(true); }} className="bg-purple-600 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-500/30 flex items-center gap-2">
                                                    <Icon path={PATHS.Edit} size={18}/> Edit Data
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <form onSubmit={(e) => {
                                        e.preventDefault();
                                        onUpdate(detailItem.id, editForm);
                                        setDetailItem({...detailItem, ...editForm});
                                        setIsEditing(false);
                                    }} className="space-y-4 animate-fade-in">
                                        {formConfig.map(f => (
                                            <div key={f.key} className={f.type === 'textarea' ? 'md:col-span-2' : ''}>
                                                <label className="text-xs font-bold text-purple-800/70 uppercase ml-1 mb-2 block tracking-wide">{f.label}</label>
                                                {f.type === 'select' ? (
                                                    <div className="relative">
                                                        <select className="input-modern cursor-pointer appearance-none" value={editForm[f.key] || ''} onChange={e => setEditForm({...editForm, [f.key]: e.target.value})}>
                                                            <option value="">Pilih...</option>
                                                            {f.options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
                                                        </select>
                                                        <Icon path={PATHS.ChevronDown} className="absolute right-3 top-3 text-purple-400 pointer-events-none" size={16}/>
                                                    </div>
                                                ) : f.type === 'textarea' ? (
                                                    <textarea className="textarea-modern" value={editForm[f.key] || ''} onChange={e => setEditForm({...editForm, [f.key]: e.target.value})} placeholder={f.placeholder || ''} required/>
                                                ) : (
                                                    <input className="input-modern" type={f.type || 'text'} value={editForm[f.key] || ''} onChange={e => setEditForm({...editForm, [f.key]: e.target.value})} placeholder={f.placeholder || ''} required/>
                                                )}
                                            </div>
                                        ))}
                                        <div className="flex gap-3 pt-4">
                                            <button type="submit" className="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-xl transition transform active:scale-95">Simpan Perubahan</button>
                                            <button type="button" onClick={() => setIsEditing(false)} className="px-6 py-3 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition">Batal</button>
                                        </div>
                                    </form>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StudentProgress = ({ db, currentUser, onUpdate }) => {
            const studentData = (db['Mahasiswa Tugas Akhir'] || []).find(m => m.NPM === currentUser.NPM);
            
            // Opsi Progres Bab
            const babOptions = [
                'Pengambilan data awal proposal',
                'Bab 1',
                'Bab 2',
                'Bab 3',
                'Bab 4',
                'Bab 5',
                'Bab 6',
                'Penelitian'
            ];

            const [formData, setFormData] = useState({
                judul: '',
                bimbingan: 0,
                deskripsi: '',
                bab: 'Pengambilan data awal proposal'
            });

            const [isDataLoaded, setIsDataLoaded] = useState(false);

            useEffect(() => {
                if (studentData && !isDataLoaded) {
                    setFormData({
                        judul: studentData.Judul || '',
                        bimbingan: studentData.BimbinganCount || 0,
                        deskripsi: studentData.ProgresDeskripsi || '',
                        bab: studentData.ProgresBab || 'Pengambilan data awal proposal'
                    });
                    setIsDataLoaded(true);
                }
            }, [studentData, isDataLoaded]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!studentData) return alert("Data mahasiswa tidak ditemukan.");
                
                onUpdate('Mahasiswa Tugas Akhir', studentData.id, {
                    Judul: formData.judul,
                    BimbinganCount: parseInt(formData.bimbingan),
                    ProgresDeskripsi: formData.deskripsi,
                    ProgresBab: formData.bab, // Menyimpan bab yang dipilih
                    LastUpdateProgres: new Date().toISOString()
                });
                alert("Data Tugas Akhir & Progres berhasil diperbarui!");
            };

            if (!studentData) return <div className="p-8 text-center text-gray-500">Data mahasiswa tidak ditemukan. Hubungi admin.</div>;

            return (
                <div className="max-w-3xl mx-auto animate-fade-in">
                    <h2 className="text-2xl font-bold text-purple-900 mb-6 flex items-center gap-3">
                        <Icon path={PATHS.Chart} className="text-pink-500"/> Data & Progres Tugas Akhir
                    </h2>
                    
                    <div className="glass p-8 rounded-3xl shadow-xl border border-white/60">
                        <div className="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-100 flex items-center justify-between">
                            <div>
                                <div className="text-xs font-bold text-purple-500 uppercase">Status Saat Ini</div>
                                <div className="font-bold text-lg text-purple-900">{studentData.Status || 'Belum Ada Status'}</div>
                            </div>
                            <div className="text-right">
                                <div className="text-xs font-bold text-purple-500 uppercase">Terakhir Diupdate</div>
                                <div className="text-sm font-medium text-gray-600">
                                    {studentData.LastUpdateProgres   
                                        ? formatDateId(studentData.LastUpdateProgres, true)   
                                        : '-'}
                                </div>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="text-sm font-bold text-purple-800 uppercase mb-2 block">Judul Tugas Akhir</label>
                                <textarea   
                                    className="textarea-modern min-h-[100px] font-semibold text-purple-900"   
                                    value={formData.judul}   
                                    onChange={e => setFormData({...formData, judul: e.target.value})}   
                                    placeholder="Masukkan Judul Tugas Akhir Anda..."   
                                    required   
                                />
                                <p className="text-[10px] text-gray-500 mt-1">Pastikan judul sesuai dengan persetujuan pembimbing.</p>
                            </div>

                            {/* --- NEW PROGRES BAB SELECTOR --- */}
                            <div>
                                <label className="text-sm font-bold text-purple-800 uppercase mb-2 block">Posisi Progres Penulisan</label>
                                <div className="relative">
                                    <select 
                                        className="input-modern cursor-pointer font-bold text-purple-700" 
                                        value={formData.bab} 
                                        onChange={e => setFormData({...formData, bab: e.target.value})}
                                    >
                                        {babOptions.map(opt => (
                                            <option key={opt} value={opt}>{opt}</option>
                                        ))}
                                    </select>
                                    <Icon path={PATHS.ChevronDown} className="absolute right-3 top-3 text-purple-400 pointer-events-none" size={16}/>
                                </div>
                                <p className="text-[10px] text-gray-500 mt-1">Pilih Bab atau tahapan penulisan yang sedang Anda kerjakan saat ini.</p>
                            </div>

                            <div>
                                <label className="text-sm font-bold text-purple-800 uppercase mb-2 block">Jumlah Bimbingan (Kali)</label>
                                <div className="relative">
                                    <input   
                                        type="number"   
                                        min="0"
                                        className="input-modern pl-12"   
                                        value={formData.bimbingan}   
                                        onChange={e => setFormData({...formData, bimbingan: e.target.value})}   
                                        required   
                                    />
                                    <div className="absolute left-4 top-3 text-purple-400 font-bold">#</div>
                                </div>
                                <p className="text-[10px] text-gray-500 mt-1">Total pertemuan bimbingan yang sudah dilakukan dengan pembimbing.</p>
                            </div>

                            <div>
                                <label className="text-sm font-bold text-purple-800 uppercase mb-2 block">Detail Progres Pengerjaan</label>
                                <textarea   
                                    className="textarea-modern min-h-[200px]"   
                                    value={formData.deskripsi}   
                                    onChange={e => setFormData({...formData, deskripsi: e.target.value})}   
                                    placeholder="Ceritakan sejauh mana pengerjaan tugas akhir Anda. Contoh: Sudah menyelesaikan Bab 3, sedang menyusun kuesioner..."   
                                    required   
                                />
                            </div>

                            <div className="pt-4 border-t border-purple-100">
                                <button type="submit" className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-purple-500/40 transition transform active:scale-95 flex items-center justify-center gap-2">
                                    <Icon path={PATHS.FileText} size={20}/> Simpan Perubahan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };
        
        const AdministrasiMenu = ({ setPage, config, userRole }) => {
            const menuItems = [
                { id: 'pengajuan_judul', label: 'Pengajuan Judul', icon: PATHS.FileText, color: 'bg-blue-100 text-blue-600', desc: 'Ajukan judul tugas akhir baru' },
                { id: 'sempro', label: 'Seminar Proposal', icon: PATHS.Book, color: 'bg-purple-100 text-purple-600', desc: 'Daftar ujian proposal' },
                { id: 'semhas', label: 'Seminar Hasil', icon: PATHS.Chart, color: 'bg-pink-100 text-pink-600', desc: 'Daftar ujian hasil' },
                { id: 'daftar_sidang', label: 'Sidang Akhir', icon: PATHS.Graduation, color: 'bg-emerald-100 text-emerald-600', desc: 'Daftar sidang tugas akhir' },
                { id: 'laporan_ta', label: 'Laporan Tugas Akhir', icon: PATHS.FileText, color: 'bg-cyan-100 text-cyan-600', desc: 'Upload laporan progres TA' },  
                { id: 'surat', label: 'Layanan Surat', icon: PATHS.Mail, color: 'bg-orange-100 text-orange-600', desc: 'Buat surat ijin riset dll' },
                { id: 'yudisium', label: 'Pendaftaran Yudisium', icon: PATHS.Tag, color: 'bg-yellow-100 text-yellow-600', desc: 'Daftar yudisium kelulusan' },
                { id: 'peminatan', label: 'Data Peminatan', icon: PATHS.Cog, color: 'bg-slate-100 text-slate-600', desc: 'Kelola data peminatan' },
            ];

            const visibleItems = menuItems.filter(item => {
                if (userRole === 'mahasiswa' && item.id === 'peminatan') return false;
                return true;
            });

            const getGformUrl = (id) => {
                if (id === 'daftar_sidang') return config.gform_sidang;
                return config[`gform_${id}`];
            };

            return (
                <div className="space-y-8 animate-fade-in pb-20">
                    <div>
                        <h2 className="text-3xl font-bold text-purple-900 mb-2">Administrasi Akademik</h2>
                        <p className="text-purple-600">Pilih menu layanan administrasi yang tersedia di bawah ini.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {visibleItems.map((item, idx) => {
                            const gformUrl = getGformUrl(item.id);
                            return (
                                <div key={item.id} className="relative group h-full" style={{animationDelay: `${idx * 100}ms`}}>
                                    <div className="glass p-6 rounded-3xl border border-white/60 shadow-lg hover:shadow-purple-500/20 transition duration-300 flex flex-col h-full relative overflow-hidden">
                                         
                                        <button 
                                            onClick={() => setPage(item.id)}
                                            className="flex items-center gap-6 text-left flex-1 outline-none"
                                        >
                                            <div className={`absolute right-0 bottom-0 opacity-10 transform translate-x-1/4 translate-y-1/4 scale-150 group-hover:scale-175 transition duration-500 pointer-events-none`}>
                                                <Icon path={item.icon} size={100} />
                                            </div>

                                            <div className={`w-16 h-16 rounded-2xl ${item.color} flex-shrink-0 flex items-center justify-center shadow-inner group-hover:scale-110 transition duration-300`}>
                                                <Icon path={item.icon} size={32}/>
                                            </div>
                                            <div className="relative z-10">
                                                <span className="font-bold text-lg text-purple-900 group-hover:text-purple-700 transition block">{item.label}</span>
                                                <span className="text-xs text-gray-500 group-hover:text-gray-600">{item.desc}</span>
                                            </div>
                                        </button>

                                        {gformUrl && (
                                            <div className="relative z-20 mt-4 pt-4 border-t border-purple-100">
                                                <a   
                                                    href={gformUrl}   
                                                    target="_blank"   
                                                    className="block w-full py-2.5 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xs font-bold rounded-xl text-center shadow-md hover:shadow-lg hover:shadow-purple-500/30 transition transform hover:-translate-y-0.5 flex items-center justify-center gap-2"
                                                >
                                                    <Icon path={PATHS.ExternalLink} size={14}/> Daftar via GForm
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const Dashboard = ({ db, userRole, currentUser }) => {
            const [greeting, setGreeting] = useState('');
            
            const globalMhs = db['Mahasiswa Tugas Akhir'] || [];
            const rawDosen = db['Data Dosen'] || [];  
            const globalJadwal = db['Jadwal Ujian TA'] || [];
            
            const dashboardMhs = useMemo(() => {
                if (userRole === 'dosen' && currentUser?.Nama) {
                    const myName = String(currentUser.Nama).trim().toLowerCase();
                    return globalMhs.filter(m => {
                        const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                        const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                        return p1 === myName || p2 === myName;
                    });
                }
                return globalMhs;  
            }, [globalMhs, userRole, currentUser]);

            const allDosen = useMemo(() => {
                const counts = {};
                globalMhs.forEach(m => {
                     if(m.Pembimbing_1 && m.Pembimbing_1 !== '-' && m.Pembimbing_1.trim() !== '') {
                        const n = m.Pembimbing_1.trim();
                        counts[n] = (counts[n] || 0) + 1;
                     }
                     if(m.Pembimbing_2 && m.Pembimbing_2 !== '-' && m.Pembimbing_2.trim() !== '') {
                        const n = m.Pembimbing_2.trim();
                        counts[n] = (counts[n] || 0) + 1;
                     }
                });
                return rawDosen.map(d => ({
                    ...d,
                    Terisi: counts[d.Nama.trim()] || 0
                }));
            }, [globalMhs, rawDosen]);

            const dashboardJadwal = useMemo(() => {
                if (userRole === 'dosen' && currentUser?.Nama) {
                     const myName = String(currentUser.Nama).trim().toLowerCase();
                     const myStudentNames = new Set(dashboardMhs.map(m => m.Nama));
                     
                     return globalJadwal.filter(j => {
                         const isMyStudent = myStudentNames.has(j.Mahasiswa);
                         const isMySchedule = String(j.Penguji_1 || '').trim().toLowerCase() === myName;
                         return isMyStudent || isMySchedule;
                     });
                }
                return globalJadwal;
            }, [globalJadwal, dashboardMhs, userRole, currentUser]);

            useEffect(() => {
                const hour = new Date().getHours();
                if (hour < 11) setGreeting('Selamat Pagi');
                else if (hour < 15) setGreeting('Selamat Siang');
                else if (hour < 19) setGreeting('Selamat Sore');
                else setGreeting('Selamat Malam');
            }, []);

            const stats = {
                totalMhs: dashboardMhs.length,
                belumProposal: dashboardMhs.filter(m => m.Status === 'Belum Proposal').length,
                sempro: dashboardMhs.filter(m => m.Status === 'Sudah Proposal').length,
                semhas: dashboardMhs.filter(m => m.Status === 'Sudah Hasil').length,
                sidang: dashboardMhs.filter(m => m.Status === 'Sudah Sidang').length,
                totalDosen: allDosen.length  
            };

            const StatCard = ({ title, value, colorClass, iconClass, delay }) => (
                <div className="glass p-6 rounded-3xl shadow-lg border border-white/60 hover:transform hover:-translate-y-1 transition duration-300 relative overflow-hidden group animate-slide-up" style={{animationDelay: delay}}>
                    <div className={`absolute -right-6 -bottom-6 p-4 opacity-5 group-hover:opacity-10 transition-opacity ${iconClass} transform group-hover:scale-125 duration-500`}>
                        <Icon path={PATHS.Chart} size={100} />
                    </div>
                    <div className="text-purple-900/60 text-[10px] uppercase font-bold tracking-wider mb-2">{title}</div>
                    <div className={`text-4xl font-extrabold ${colorClass} drop-shadow-sm flex items-baseline gap-2`}>
                        {value} <span className="text-sm font-normal text-gray-400">Org</span>
                    </div>
                </div>
            );

            const WorkloadChart = ({ dosenData }) => {
                return (
                    <div className="space-y-5">
                        {dosenData.map((d, idx) => {
                            const percent = Math.min((d.Terisi / d.Kuota) * 100, 100);
                            const isFull = d.Terisi >= d.Kuota;
                            return (
                                <div key={d.id} className="relative group cursor-default">
                                    <div className="flex justify-between text-sm mb-1.5 font-medium items-end">
                                        <div className="flex flex-col">
                                            <span className="text-purple-900 font-bold">{d.Nama}</span>
                                            <span className="text-[10px] text-purple-400">{d.Keahlian}</span>
                                        </div>
                                        <span className={`font-bold px-2 py-0.5 rounded-md text-xs ${isFull ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                                            {d.Terisi}/{d.Kuota}
                                        </span>
                                    </div>
                                    <div className="w-full bg-white/50 rounded-full h-2.5 overflow-hidden shadow-inner">
                                        <div className={`h-full rounded-full transition-all duration-1000 ease-out shadow-sm relative overflow-hidden ${isFull ? 'bg-gradient-to-r from-red-400 to-red-600' : 'bg-gradient-to-r from-violet-400 to-fuchsia-500'}`} style={{ width: `${percent}%`, transitionDelay: `${idx * 100}ms` }}>
                                            <div className="absolute top-0 left-0 w-full h-full bg-white/20 animate-pulse-slow"></div>
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                );
            };

            return (
                <div className="space-y-8 pb-24 animate-fade-in">
                    <div className="flex justify-between items-end">
                        <div>
                            <h1 className="text-3xl md:text-4xl font-bold text-purple-900 mb-1">{greeting}</h1>
                            <p className="text-purple-500 font-medium">Berikut ringkasan aktivitas akademik {userRole === 'dosen' ? 'bimbingan Anda' : 'hari ini'}.</p>
                        </div>
                        <div className="hidden md:block text-right">
                            <div className="text-2xl font-bold text-purple-800">{formatDateId(new Date())}</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4 md:gap-6">
                        <StatCard title="Total Mahasiswa" value={stats.totalMhs} colorClass="text-purple-700" iconClass="text-purple-500" delay="0ms"/>
                        <StatCard title="Data Dosen" value={stats.totalDosen} colorClass="text-indigo-600" iconClass="text-indigo-500" delay="100ms"/>
                        <StatCard title="Belum Proposal" value={stats.belumProposal} colorClass="text-emerald-500" iconClass="text-emerald-500" delay="200ms"/>
                        <StatCard title="Sudah Proposal" value={stats.sempro} colorClass="text-orange-500" iconClass="text-orange-500" delay="300ms"/>
                        <StatCard title="Sudah Hasil" value={stats.semhas} colorClass="text-pink-500" iconClass="text-pink-500" delay="400ms"/>
                        <StatCard title="Sudah Sidang" value={stats.sidang} colorClass="text-rose-600" iconClass="text-rose-500" delay="500ms"/>
                    </div>

                    <div className="grid md:grid-cols-3 gap-6 md:gap-8">
                        <div className="md:col-span-2 glass p-6 md:p-8 rounded-3xl shadow-xl border border-white/60">
                            <h3 className="font-bold text-lg text-purple-900 mb-6 flex items-center gap-3">
                                <span className="p-2 bg-purple-100 text-purple-600 rounded-lg"><Icon path={PATHS.Chart}/></span>   
                                Beban Bimbingan Dosen (Global)
                            </h3>
                            <WorkloadChart dosenData={allDosen} />
                        </div>

                        <div className="bg-gradient-to-b from-slate-800 to-slate-900 text-white p-6 md:p-8 rounded-3xl shadow-2xl relative overflow-hidden flex flex-col h-96">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-purple-500 opacity-20 rounded-full blur-3xl -mr-20 -mt-20"></div>
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-3 relative z-10">
                                <span className="p-2 bg-white/10 rounded-lg"><Icon path={PATHS.Book}/></span>
                                Jadwal Terdekat
                            </h3>
                            <div className="space-y-3 overflow-y-auto flex-1 pr-2 custom-scrollbar relative z-10">
                                {dashboardJadwal.slice(0, 5).map((j, i) => (
                                    <div key={i} className="bg-white/5 backdrop-blur-sm p-3 rounded-xl border border-white/10 hover:bg-white/10 transition group">
                                        <div className="flex justify-between items-start mb-1">
                                            <div className="font-bold text-sm text-yellow-300 group-hover:text-yellow-200 transition">{j.Mahasiswa}</div>
                                            <span className="text-[10px] bg-purple-600 px-2 py-0.5 rounded text-white">{j.Jenis.split(' ')[1] || j.Jenis}</span>
                                        </div>
                                        <div className="text-xs text-slate-300 flex flex-wrap gap-x-3 gap-y-1 mt-2">
                                             <span className="flex items-center gap-1 text-pink-300 font-medium">
                                                <Icon path={PATHS.FileText} size={12}/>   
                                                {formatDateId(j.Tanggal)}
                                             </span>
                                             <span className="flex items-center gap-1"><Icon path={PATHS.Sun} size={12}/> {j.Jam}</span>
                                             <span className="flex items-center gap-1"><Icon path={PATHS.Home} size={12}/> {j.Ruang}</span>
                                        </div>
                                    </div>
                                ))}
                                {dashboardJadwal.length === 0 && <p className="text-sm text-slate-400 text-center py-10">Belum ada jadwal {userRole === 'dosen' ? 'untuk mahasiswa Anda' : ''}.</p>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CHATBOT COMPONENT ---
        const ChatBot = ({ db, currentUser, userRole, isOpen, onToggle }) => {
            const [input, setInput] = useState('');
            const [messages, setMessages] = useState([
                { id: 1, text: "Halo! Ada yang bisa saya bantu?", sender: 'bot' }
            ]);
            const [isTyping, setIsTyping] = useState(false);
            const chatEndRef = useRef(null);

            useEffect(() => {
                if (chatEndRef.current) {
                    chatEndRef.current.scrollIntoView({ behavior: 'smooth' });
                }
            }, [messages, isOpen]);

            const quickActions = useMemo(() => {
                if (userRole === 'mahasiswa') {
                    return [
                        { label: "Cek Jadwal Saya", query: "jadwal saya", icon: PATHS.Sun },
                        { label: "Siapa Pembimbing?", query: "pembimbing saya", icon: PATHS.User },
                        { label: "Judul Tugas Akhir", query: "judul tugas akhir", icon: PATHS.FileText },
                        { label: "Bantuan", query: "bantuan", icon: PATHS.Info },
                    ];
                } else if (userRole === 'dosen') {
                    return [
                        { label: "Data Bimbingan", query: "data bimbingan saya", icon: PATHS.Users },
                        { label: "Cek Jadwal", query: "jadwal ujian", icon: PATHS.Sun },
                        { label: "Beban Kerja", query: "beban kerja", icon: PATHS.Chart },
                        { label: "Pusat Bantuan", query: "bantuan", icon: PATHS.Info },
                    ];
                }
                return [];
            }, [userRole]);

            const generateBotResponse = (query, db, currentUser) => {
                const q = query.toLowerCase();
                
                if (userRole === 'mahasiswa') {
                    if (q.includes('jadwal saya') || q.includes('kapan ujian')) {
                        const mySchedule = (db['Jadwal Ujian TA'] || []).filter(j => j.Mahasiswa === currentUser.Nama);
                        if (mySchedule.length > 0) {
                            return `Jadwal Anda:\n${mySchedule.map(j => `- ${j.Jenis}: ${formatDateId(j.Tanggal)} jam ${j.Jam} di ${j.Ruang}`).join('\n')}`;
                        } else {
                            return "Saya tidak menemukan jadwal ujian untuk nama Anda saat ini.";
                        }
                    }
                    if (q.includes('pembimbing') || q.includes('dosen saya')) {
                        const p1 = currentUser.Pembimbing_1;
                        const p2 = currentUser.Pembimbing_2;
                        if (p1 && p2) return `Pembimbing Anda adalah ${p1} (Pembimbing 1) dan ${p2} (Pembimbing 2).`;
                        if (p1) return `Pembimbing Anda adalah ${p1}.`;
                        return "Data pembimbing belum tersedia.";
                    }
                    if (q.includes('judul') || q.includes('topik')) {
                        return `Judul TA Anda saat ini: "${currentUser.Judul || '-'}"`;
                    }
                }

                if (userRole === 'dosen' && q.includes('data bimbingan')) {
                    const myStudents = (db['Mahasiswa Tugas Akhir'] || []).filter(m => {
                        const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                        const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                        const myName = String(currentUser.Nama).trim().toLowerCase();
                        return p1 === myName || p2 === myName;
                    });
                    
                    if (myStudents.length > 0) {
                        return `Daftar ${myStudents.length} mahasiswa bimbingan Anda:\n${myStudents.map(m => `- ${m.Nama} (${m.NPM}) - ${m.Status}`).join('\n')}`;
                    } else {
                        return "Anda belum memiliki data mahasiswa bimbingan.";
                    }
                }
                
                if (userRole === 'dosen' && q.includes('beban kerja')) {
                     const total = (db['Mahasiswa Tugas Akhir'] || []).filter(m => {
                        const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                        const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                        const myName = String(currentUser.Nama).trim().toLowerCase();
                        return p1 === myName || p2 === myName;
                     }).length;
                     return `Total beban kerja bimbingan Anda saat ini adalah ${total} mahasiswa.`;
                }

                if (q.includes('cari jadwal') || q.includes('jadwal')) {
                    const nameKeywords = q.replace('cari jadwal', '').replace('jadwal', '').trim();
                    if (nameKeywords.length > 3) {
                        const results = (db['Jadwal Ujian TA'] || []).filter(j =>   
                            j.Mahasiswa.toLowerCase().includes(nameKeywords)
                        );
                        if (results.length > 0) {
                            return `Ditemukan ${results.length} jadwal:\n${results.map(j => `- ${j.Mahasiswa}: ${j.Jenis} tgl ${formatDateId(j.Tanggal)}`).join('\n')}`;
                        }
                        return `Maaf, saya tidak menemukan jadwal untuk "${nameKeywords}".`;
                    }
                    return "Untuk mencari jadwal, ketik 'Cari jadwal [Nama Mahasiswa]'.";
                }

                if (q.includes('halo') || q.includes('hai')) return "Halo! Semangat mengerjakan TA ya!";
                if (q.includes('terima kasih') || q.includes('makasih')) return "Sama-sama! Semoga dilancarkan tugas akhirnya.";
                if (q.includes('sempro')) return "Seminar Proposal biasanya diadakan setelah judul disetujui. Cek menu Administrasi untuk pendaftaran.";
                if (q.includes('semhas')) return "Seminar Hasil adalah ujian presentasi hasil penelitian tengah. Pastikan laporan sudah siap!";
                if (q.includes('login') || q.includes('masuk')) return "Silakan login menggunakan NPM (Mahasiswa) atau NIDN (Dosen/Tendik). Password default sama dengan ID.";
                
                return "Maaf, saya kurang paham. Coba tanyakan tentang 'jadwal', 'pembimbing', atau 'cari jadwal [nama]'.";
            };

            const handleSend = (e) => {
                e.preventDefault();
                if (!input.trim()) return;

                const userMsg = { id: Date.now(), text: input, sender: 'user' };
                setMessages(prev => [...prev, userMsg]);
                setInput('');
                setIsTyping(true);

                setTimeout(() => {
                    const botResponseText = generateBotResponse(userMsg.text, db, currentUser);
                    const botMsg = { id: Date.now() + 1, text: botResponseText, sender: 'bot' };
                    setMessages(prev => [...prev, botMsg]);
                    setIsTyping(false);
                }, 1000);
            };

            return (
                <>
                    {!isOpen && (
                        <button   
                            onClick={onToggle}
                            className="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full shadow-2xl shadow-purple-500/40 flex items-center justify-center text-white z-50 hover:scale-110 transition transform animate-bounce-slight"
                            title="Buka Chat"
                        >
                            <Icon path={PATHS.MessageCircle} size={32} />
                        </button>
                    )}

                    {isOpen && (
                        <div className="fixed bottom-6 right-6 md:right-6 w-[calc(100%-2rem)] md:w-96 h-[500px] bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/60 z-50 flex flex-col animate-slide-up overflow-hidden">
                            
                            <div className="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 flex items-center justify-between text-white shadow-lg">
                                <div className="flex items-center gap-3">
                                    <div className="relative">
                                        <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                                            <Icon path={PATHS.Robot} size={20}/>
                                        </div>
                                        <div className="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-purple-600 animate-pulse"></div>
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-sm">FIKPsi Bot</h3>
                                        <p className="text-[10px] text-white/70">Online â€¢ Otomatis</p>
                                    </div>
                                </div>
                                <button onClick={onToggle} className="p-1 hover:bg-white/20 rounded-full transition">
                                    <Icon path={PATHS.Minimize2} size={20} />
                                </button>
                            </div>

                            <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-purple-50/30 custom-scrollbar">
                                {messages.map((msg, index) => (
                                    <div key={msg.id}>
                                        <div className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] p-3 rounded-2xl text-sm shadow-sm ${
                                                msg.sender === 'user'   
                                                    ? 'bg-gradient-to-br from-purple-600 to-pink-600 text-white rounded-br-none'   
                                                    : 'bg-white text-gray-700 border border-purple-100 rounded-bl-none'
                                            }`}>
                                                <span className="whitespace-pre-wrap leading-relaxed">{msg.text}</span>
                                            </div>
                                        </div>
                                        
                                        {msg.sender === 'bot' && index === 0 && quickActions.length > 0 && (
                                            <div className="flex flex-wrap gap-2 mt-3 animate-fade-in">
                                                {quickActions.map((action, i) => (
                                                    <button
                                                        key={i}
                                                        onClick={() => handleSend({ preventDefault: () => {}, target: { value: action.query } })}
                                                        className="px-3 py-1.5 bg-white border border-purple-200 text-purple-700 rounded-full text-xs font-bold shadow-sm hover:bg-purple-50 hover:border-purple-400 transition flex items-center gap-2"
                                                    >
                                                        <Icon path={action.icon} size={12} />
                                                        {action.label}
                                                    </button>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                                {isTyping && (
                                    <div className="flex justify-start">
                                        <div className="bg-white border border-purple-100 p-3 rounded-2xl rounded-bl-none shadow-sm flex items-center gap-1">
                                            <div className="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                                            <div className="w-2 h-2 bg-purple-400 rounded-full typing-dot"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef} />
                            </div>

                            <form onSubmit={handleSend} className="p-3 bg-white border-t border-purple-100 flex items-center gap-2">
                                <input   
                                    type="text"   
                                    className="flex-1 bg-purple-50 border border-purple-100 rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition"
                                    placeholder="Ketik pertanyaan..."
                                    value={input}
                                    onChange={e => setInput(e.target.value)}
                                    autoComplete="off"
                                />
                                <button   
                                    type="submit"   
                                    disabled={!input.trim()}
                                    className="p-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-md"
                                >
                                    <Icon path={PATHS.Send} size={18} />
                                </button>
                            </form>
                        </div>
                    )}
                </>
            );
        };

        const App = () => {
            const [page, setPage] = useState('dashboard');
            const [userRole, setUserRole] = useState(null);  
            const [currentUser, setCurrentUser] = useState(null);
            const [showLogin, setShowLogin] = useState(false);
            const [menuOpen, setMenuOpen] = useState(false);
            const [notification, setNotification] = useState(null);
            const [isChatOpen, setIsChatOpen] = useState(false);  
            
            const [config, setConfig] = useStickyState({  
                app_name: 'SI Tugas Akhir FIKPsi',  
                scriptUrl: 'https://script.google.com/macros/s/AKfycby1xNCAWskg2zGUeEL1lR09yd9ozBIcymxk_-XGNlSoOA1m1mssSTle49IyeIRtgGCcUw/exec',  
                ai_api_key: '',          
                ai_key_openai: '', 
                ai_key_deepseek: '',
                ai_key_groq: '',          
                ai_key_cohere: '',          
                ai_key_huggingface: '',
                gform_pengajuan_judul: '', 
                gform_sempro: '', 
                gform_semhas: '', 
                gform_sidang: '', 
                gform_surat: '', 
                gform_yudisium: '',
                gform_laporan_ta: ''  
            }, 'sim_config_ta_v10_progresbab'); 

            const { db, add, del, update, isOnline, refresh, importBatch, batchUpdate, isLoading, isBackgroundSyncing, lastSyncTime, save } = useDatabase(INITIAL_DB, config.scriptUrl);

            const crud = { add, del, update };

            const recalculateDosenQuota = (mahasiswaList, dosenList) => {
                let updatedDosen = [...dosenList];
                const counts = {};
                const extractedNames = new Set();

                mahasiswaList.forEach(m => {
                    if(m.Pembimbing_1 && m.Pembimbing_1 !== '-' && m.Pembimbing_1.trim() !== '') {
                        const name = m.Pembimbing_1.trim();
                        counts[name] = (counts[name] || 0) + 1;
                        extractedNames.add(name);
                    }
                    if(m.Pembimbing_2 && m.Pembimbing_2 !== '-' && m.Pembimbing_2.trim() !== '') {
                        const name = m.Pembimbing_2.trim();
                        counts[name] = (counts[name] || 0) + 1;
                        extractedNames.add(name);
                    }
                    
                    if(m.Penguji && m.Penguji !== '-' && m.Penguji.trim() !== '') extractedNames.add(m.Penguji.trim());
                });
                
                updatedDosen = updatedDosen.map(d => ({
                    ...d,
                    Terisi: counts[d.Nama.trim()] || 0
                }));

                extractedNames.forEach(name => {
                    const exists = updatedDosen.some(d => d.Nama.toLowerCase().trim() === name.toLowerCase());
                    if (!exists) {
                        updatedDosen.push({
                            id: Date.now() + Math.random(),
                            Nama: name,
                            NIDN: "-", 
                            Keahlian: "Umum", 
                            Kuota: 10, 
                            Terisi: counts[name] || 0
                        });
                    }
                });

                return updatedDosen;
            };

            const handleStudentChange = (action, id, data) => {
                let newMhsList = [...(db['Mahasiswa Tugas Akhir'] || [])];
                const oldDosenList = db['Data Dosen'] || [];
                
                if (action === 'add') {
                    const newItem = { id: Date.now(), ...data };
                    newMhsList.push(newItem);
                    save('create', 'Mahasiswa Tugas Akhir', newItem);
                } else if (action === 'update') {
                    newMhsList = newMhsList.map(m => m.id === id ? { ...m, ...data } : m);
                    save('update', 'Mahasiswa Tugas Akhir', { id, ...data });
                } else if (action === 'delete') {
                    newMhsList = newMhsList.filter(m => m.id !== id);
                    save('delete', 'Mahasiswa Tugas Akhir', { id });
                }

                const updatedDosen = recalculateDosenQuota(newMhsList, oldDosenList);

                updatedDosen.forEach(dNew => {
                    const dOld = oldDosenList.find(d => d.id === dNew.id);
                    if (!dOld) {
                        save('create', 'Data Dosen', dNew);
                    } else if (dOld.Terisi !== dNew.Terisi) {
                        save('update', 'Data Dosen', { id: dNew.id, Terisi: dNew.Terisi });
                    }
                });

                batchUpdate({
                    'Mahasiswa Tugas Akhir': newMhsList,
                    'Data Dosen': updatedDosen
                });
                
                if(action === 'add') alert('Data Mahasiswa berhasil disimpan & Kuota Dosen diperbarui!');
                if(action === 'update') alert('Data Mahasiswa berhasil diperbarui & Kuota Dosen diperbarui!');
            };

            const handlePengajuanJudul = (data) => {
                const newPengajuan = { id: Date.now(), ...data };
                const existingMhs = (db['Mahasiswa Tugas Akhir'] || []).find(m => m.NPM === data.NPM);
                let newMhsList = [...(db['Mahasiswa Tugas Akhir'] || [])];

                if (existingMhs) {
                    const updatedData = { ...existingMhs, Judul: data.Judul, Peminatan: data.Peminatan, Status: 'Belum Proposal' };
                    newMhsList = newMhsList.map(m => m.NPM === data.NPM ? updatedData : m);
                    save('update', 'Mahasiswa Tugas Akhir', updatedData); 
                } else {
                    const newMhs = {
                        id: Date.now() + 1,
                        Nama: data.Nama,
                        NPM: data.NPM,
                        Prodi: "S1 Ilmu Kesehatan Masyarakat",
                        Angkatan: "20" + (data.NPM ? data.NPM.substring(2,4) : "20"), 
                        Peminatan: data.Peminatan,
                        Judul: data.Judul,
                        Status: "Belum Proposal",
                        Pembimbing_1: "-",
                        Pembimbing_2: "-"
                    };
                    newMhsList.push(newMhs);
                    save('create', 'Mahasiswa Tugas Akhir', newMhs); 
                }

                save('create', 'Pengajuan Judul', newPengajuan); 

                batchUpdate({
                    'Pengajuan Judul': [...(db['Pengajuan Judul'] || []), newPengajuan],
                    'Mahasiswa Tugas Akhir': newMhsList
                });
                alert("Pengajuan Judul tersimpan! Data Mahasiswa otomatis diperbarui ke 'Belum Proposal'.");
            };

            const handleRegistration = (collectionName, data, targetStatus) => {
                const newReg = { id: Date.now(), ...data };
                const existingMhs = (db['Mahasiswa Tugas Akhir'] || []).find(m => m.Nama === data.Nama);
                let newMhsList = [...(db['Mahasiswa Tugas Akhir'] || [])];

                if (existingMhs) {
                    const updatedMhs = { ...existingMhs, Status: targetStatus };
                    newMhsList = newMhsList.map(m => m.id === existingMhs.id ? updatedMhs : m);
                    save('update', 'Mahasiswa Tugas Akhir', updatedMhs); 
                }

                save('create', collectionName, newReg); 

                batchUpdate({
                    [collectionName]: [...(db[collectionName] || []), newReg],
                    'Mahasiswa Tugas Akhir': newMhsList
                });
                alert(`Pendaftaran berhasil disimpan! Status mahasiswa diperbarui menjadi '${targetStatus}'.`);
            };

            const handleRoleLogin = (role, userData = null) => {
                setUserRole(role);
                setCurrentUser(userData);
                setShowLogin(false);
                
                if (role === 'mahasiswa') {
                    setPage('bimbingan'); 
                } else if (role === 'tendik') {
                    setPage('informasi');
                } else {
                    setPage('dashboard'); 
                }

                const latestInfo = db['Informasi'] && db['Informasi'].length > 0 ? db['Informasi'][db['Informasi'].length - 1] : null;
                const latestJadwal = db['Jadwal Ujian TA'] && db['Jadwal Ujian TA'].length > 0 ? db['Jadwal Ujian TA'][db['Jadwal Ujian TA'].length - 1] : null;
                
                const latestChat = db['BimbinganChats'] ? db['BimbinganChats'].filter(c => c.receiver === (userData ? userData.Nama : '')).pop() : null;

                let notifContent = null;

                if (role === 'mahasiswa' && userData) {
                    if (latestChat) {
                        notifContent = {
                            type: 'Pesan Bimbingan Baru',
                            title: `Dari: ${latestChat.sender}`,
                            message: latestChat.message.length > 50 ? latestChat.message.substring(0,50) + '...' : latestChat.message
                        };
                    } else if (latestJadwal) {
                         notifContent = {
                            type: 'Jadwal Terbaru',
                            title: `Ujian ${latestJadwal.Jenis}`,
                            message: `${latestJadwal.Mahasiswa} akan ujian pada ${formatDateId(latestJadwal.Tanggal)} di ${latestJadwal.Ruang}. Semangat!`
                        };
                    } else if (latestInfo) {
                        notifContent = {
                            type: 'Info Akademik',
                            title: latestInfo.Judul,
                            message: latestInfo.Isi.length > 80 ? latestInfo.Isi.substring(0, 80) + '...' : latestInfo.Isi
                        };
                    }

                } else {
                    if (latestChat) {
                        notifContent = {
                            type: 'Pesan Bimbingan Baru',
                            title: `Dari: ${latestChat.sender}`,
                            message: latestChat.message.length > 50 ? latestChat.message.substring(0,50) + '...' : latestChat.message
                        };
                    } else if (latestInfo) {
                        notifContent = {
                            type: 'Pengumuman Baru',
                            title: latestInfo.Judul,
                            message: latestInfo.Isi.length > 80 ? latestInfo.Isi.substring(0, 80) + '...' : latestInfo.Isi
                        };
                    }
                }

                if (notifContent) {
                    setTimeout(() => {
                        setNotification({
                            user: userData ? userData.Nama : (role === 'admin' ? 'Admin' : role === 'tendik' ? 'Staf Akademik' : 'Bapak/Ibu'),  
                            ...notifContent
                        });
                    }, 800); 
                }
            };

            const NavItem = ({ name, icon, label, onClick, isActive, badge }) => (
                <button   
                    onClick={onClick}   
                    className={`w-full text-left px-4 py-3.5 rounded-2xl text-sm font-semibold transition-all duration-300 flex items-center justify-between mb-1.5 group
                    ${isActive
                        ? 'bg-white text-purple-700 shadow-lg shadow-purple-900/10'   
                        : 'text-purple-100/70 hover:bg-white/10 hover:text-white'
                    }`}
                >
                    <div className="flex items-center gap-3">
                        <Icon path={icon} className={isActive ? 'text-pink-500' : 'text-purple-300 group-hover:text-white'} /> {label}
                    </div>
                    {badge && <span className="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">{badge}</span>}
                    {isActive && !badge && <div className="w-1.5 h-1.5 rounded-full bg-pink-500 shadow-sm"></div>}
                </button>
            );

            const dosenOptions = (db['Data Dosen'] || []).map(d => ({ value: d.Nama, label: d.Nama }));
            
            const mhsOptions = (db['Mahasiswa Tugas Akhir'] || [])
                .map(m => ({ value: m.Nama, label: `${m.Nama} - ${m.NPM}` }))
                .sort((a, b) => a.label.localeCompare(b.label));

            const jadwalFormConfig = [
                {key:'Mahasiswa', label:'Nama Mahasiswa', type: 'select', options: mhsOptions},
                {key:'Jenis', label:'Jenis Ujian', type: 'select', options:[{value:'Seminar Proposal', label:'Sempro'}, {value:'Seminar Hasil', label:'Semhas'}, {value:'Sidang', label:'Sidang'}]},
                {key:'Tanggal', label:'Tanggal', type:'date'},
                {key:'Jam', label:'Jam'},
                {key:'Ruang', label:'Ruangan'}
            ];
            
            const mahasiswaFormConfig = [
                {key:'Nama', label:'Nama Mahasiswa'}, {key:'NPM', label:'NPM'},
                {key:'Prodi', label:'Program Studi', type: 'select', options:[
                    {value:'S1 Ilmu Kesehatan Masyarakat', label:'S1 Ilmu Kesehatan Masyarakat'},  
                    {value:'S1 Psikologi', label:'S1 Psikologi'},
                    {value:'S2 Kesehatan Masyarakat', label:'S2 Kesehatan Masyarakat'}
                ]},
                {key:'Peminatan', label:'Peminatan', type: 'select', options: (db['Data Peminatan'] || []).map(p => ({ value: p.Nama, label: p.Nama })) },
                {key:'StatusAkademik', label:'Status Akademik', type: 'select', options:[
                    {value:'Aktif', label:'Aktif'},  
                    {value:'Non-Aktif', label:'Non-Aktif'},  
                    {value:'Cuti', label:'Cuti'},
                    {value:'Limit DO', label:'Limit DO'}
                ]},
                {key:'Status', label:'Tahapan', type: 'select', options:[
                    {value:'Belum Proposal', label:'Belum Proposal'},  
                    {value:'Sudah Proposal', label:'Sudah Proposal'},  
                    {value:'Sudah Hasil', label:'Sudah Hasil'},  
                    {value:'Sudah Sidang', label:'Sudah Sidang'},
                    {value:'Lulus', label:'Lulus'}
                ]},
                {key:'Pembimbing_1', label:'Pembimbing 1', type: 'select', options: dosenOptions},  
                {key:'Pembimbing_2', label:'Pembimbing 2', type: 'select', options: dosenOptions},
                {key:'Penguji', label:'Penguji', type: 'select', options: dosenOptions},
                {key:'Judul', label:'Judul Tugas Akhir', type:'textarea'},
                {key:'LinkLaporan', label:'Link Laporan GDrive (Admin)', placeholder: 'https://...'}  
            ];

            const PAGE_MAP = {
                'pengajuan_judul': { title: 'Pengajuan Judul Tugas Akhir', collection: 'Pengajuan Judul', configKey: 'Pengajuan Judul', status: 'Belum Proposal' },
                'sempro': { title: 'Seminar Proposal', collection: 'Pendaftaran Sempro', configKey: 'Pendaftaran Sempro', status: 'Sudah Proposal' },
                'semhas': { title: 'Seminar Hasil', collection: 'Pendaftaran Semhas', configKey: 'Pendaftaran Semhas', status: 'Sudah Hasil' },
                'daftar_sidang': { title: 'Sidang Akhir', collection: 'Pendaftaran Sidang', configKey: 'Pendaftaran Sidang', status: 'Sudah Sidang' },
                'surat': { title: 'Layanan Surat', collection: 'Layanan Surat', configKey: 'Layanan Surat', status: null },  
                'yudisium': { title: 'Pendaftaran Yudisium', collection: 'Data Yudisium', configKey: 'Data Yudisium', status: null },
                'peminatan': { title: 'Data Peminatan', collection: 'Data Peminatan', configKey: 'Data Peminatan', status: null },
                'laporan_ta': { title: 'Laporan Tugas Akhir', collection: 'Laporan TA', configKey: 'Laporan TA', status: null }  
            };
            
            const jadwalData = useMemo(() => {
                return (db['Jadwal Ujian TA'] || []).map(j => {
                    const mhs = (db['Mahasiswa Tugas Akhir'] || []).find(m => m.Nama === j.Mahasiswa);
                    if (mhs) {
                        return {  
                            ...j,  
                            "Judul Tugas Akhir": mhs.Judul,  
                            "Pembimbing 1": mhs.Pembimbing_1,
                            "Pembimbing 2": mhs.Pembimbing_2,  
                            "Penguji Mahasiswa": mhs.Penguji          
                        };
                    }
                    return j;
                });
            }, [db]);

            const getGformUrl = (pageId) => {
                if (pageId === 'daftar_sidang') return config.gform_sidang;
                return config[`gform_${pageId}`];
            }

            if (!userRole) {
                return (
                    <div className="flex items-center justify-center min-h-screen relative overflow-hidden">
                        <LoginCard isModal={false} db={db} handleRoleLogin={handleRoleLogin} setShowLogin={setShowLogin} onRefresh={refresh} isLoading={isLoading}/>
                    </div>
                )
            }

            const Sidebar = () => (
                <>
                    <div className={`fixed inset-0 bg-purple-900/40 backdrop-blur-sm z-30 md:hidden transition-opacity duration-300 ${menuOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={()=>setMenuOpen(false)}/>
                    <div className={`w-72 bg-[#2d0f59]/90 backdrop-filter backdrop-blur-xl h-screen fixed top-0 left-0 border-r border-white/10 flex flex-col z-40 transform transition-transform duration-300 ease-out md:translate-x-0 ${menuOpen ? 'translate-x-0' : '-translate-x-full'} shadow-2xl`}>
                        <div className="p-8 pb-6">
                            <div className="w-10 h-10 bg-gradient-to-tr from-pink-500 to-purple-600 rounded-xl mb-4 flex items-center justify-center text-white shadow-lg shadow-purple-500/30">
                                <Icon path={PATHS.Graduation} size={24}/>
                            </div>
                            <div className="font-extrabold text-2xl text-white tracking-tight leading-none">SI TA <span className="text-purple-400">FIKPsi</span></div>
                            <div className="text-[10px] font-bold text-purple-400/60 uppercase tracking-widest mt-1">Integrated System</div>
                        </div>
                        <nav className="flex-1 px-4 py-2 overflow-y-auto custom-scrollbar space-y-1">
                            {(userRole === 'admin' || userRole === 'dosen') && (
                                <NavItem name="dashboard" icon={PATHS.Home} label="Dashboard" onClick={()=>{setPage('dashboard'); setMenuOpen(false)}} isActive={page==='dashboard'}/>
                            )}
                            {(userRole === 'admin' || userRole === 'dosen') && (
                                <NavItem name="mahasiswa" icon={PATHS.Users} label="Data Mahasiswa" onClick={()=>{setPage('mahasiswa'); setMenuOpen(false)}} isActive={page==='mahasiswa'}/>
                            )}
                            {userRole === 'dosen' && (
                                <NavItem name="tugas_akhir" icon={PATHS.FileText} label="Tugas Akhir Mahasiswa" onClick={()=>{setPage('tugas_akhir'); setMenuOpen(false)}} isActive={page==='tugas_akhir'}/>
                            )}
                            {(userRole === 'mahasiswa' || userRole === 'dosen') && (
                                <NavItem   
                                    name="bimbingan"   
                                    icon={PATHS.MessageSquare}   
                                    label="Bimbingan Tugas Akhir"   
                                    onClick={()=>{setPage('bimbingan'); setMenuOpen(false)}}   
                                    isActive={page==='bimbingan'}
                                    badge={(db['BimbinganChats'] || []).filter(c => c.receiver === currentUser?.Nama).length > 0 ? (db['BimbinganChats'] || []).filter(c => c.receiver === currentUser?.Nama).length : null}
                                />
                            )}
                            {userRole === 'admin' && (
                                <>
                                    <NavItem name="dosen" icon={PATHS.User} label="Data Dosen" onClick={()=>{setPage('dosen'); setMenuOpen(false)}} isActive={page==='dosen'}/>
                                    <NavItem name="peminatan" icon={PATHS.Cog} label="Data Peminatan" onClick={()=>{setPage('peminatan'); setMenuOpen(false)}} isActive={page==='peminatan'}/>
                                </>
                            )}
                            <NavItem name="informasi" icon={PATHS.Bell} label="Informasi" onClick={()=>{setPage('informasi'); setMenuOpen(false)}} isActive={page==='informasi'}/>
                            {(userRole === 'admin' || userRole === 'mahasiswa' || userRole === 'tendik' || userRole === 'dosen') && (
                                <NavItem name="sidang" icon={PATHS.Sun} label="Jadwal Ujian" onClick={()=>{setPage('sidang'); setMenuOpen(false)}} isActive={page==='sidang'}/>
                            )}
                            {(userRole === 'admin' || userRole === 'mahasiswa') && (
                                <NavItem name="administrasi" icon={PATHS.Clip} label="Administrasi" onClick={()=>{setPage('administrasi'); setMenuOpen(false)}} isActive={page === 'administrasi' || Object.keys(PAGE_MAP).includes(page)}/>
                            )}
                            {(userRole === 'admin' || userRole === 'dosen' || userRole === 'mahasiswa') && (
                                <NavItem name="unduh" icon={PATHS.Cloud} label="Pusat Unduhan" onClick={()=>{setPage('unduh'); setMenuOpen(false)}} isActive={page==='unduh'}/>
                            )}
                            {userRole === 'mahasiswa' && (
                                <NavItem name="progres" icon={PATHS.Chart} label="Lapor Progres" onClick={()=>{setPage('progres'); setMenuOpen(false)}} isActive={page==='progres'}/>
                            )}
                        </nav>
                        
                        <div className="px-6 py-2">
                             <div className="flex items-center justify-between text-[10px] text-purple-300 bg-white/5 rounded-lg p-2 border border-white/5">
                                 <div className="flex items-center gap-2">
                                     <div className={`w-2 h-2 rounded-full ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                     {isBackgroundSyncing ? 'Menyimpan...' : (isOnline ? 'Live Sync' : 'Offline')}
                                 </div>
                                 <div className="opacity-60">{lastSyncTime ? lastSyncTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--'}</div>
                             </div>
                        </div>

                        <div className="p-6 bg-black/20 mx-4 mb-4 rounded-2xl border border-white/5">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white text-xs font-bold">
                                    {userRole.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div className="text-white text-sm font-bold capitalize">{currentUser ? currentUser.Nama : userRole}</div>
                                    <div className="text-purple-400 text-[10px]">{userRole}</div>
                                </div>
                            </div>
                            <button onClick={()=>{setShowLogin(true); setMenuOpen(false)}} className="w-full py-2 bg-white/10 hover:bg-white/20 rounded-lg text-xs font-bold text-white transition flex items-center justify-center gap-2">
                                <Icon path={PATHS.Logout} size={14}/> Keluar / Ganti
                            </button>
                            {userRole === 'admin' && (
                                <button onClick={()=>{setPage('settings'); setMenuOpen(false)}} className="mt-2 w-full text-center text-[10px] text-purple-400 hover:text-white transition flex justify-center gap-1 items-center"><Icon path={PATHS.Cog} size={10}/> Pengaturan</button>
                            )}
                        </div>
                    </div>
                </>
            );

            return (
                <div className="flex min-h-screen relative">
                    <Sidebar/>
                    <div className="md:hidden fixed top-0 w-full glass z-20 px-6 py-4 flex justify-between items-center shadow-sm">
                         <div className="font-extrabold text-lg text-purple-800 flex items-center gap-2"><div className="w-6 h-6 bg-pink-500 rounded-lg"></div> FIKPsi Sys</div>
                         <button onClick={()=>setMenuOpen(true)} className="p-2 text-purple-600 bg-white rounded-xl shadow-sm border border-purple-100 active:scale-95 transition"><Icon path={PATHS.Menu} size={24}/></button>
                    </div>

                    <main className="flex-1 md:ml-72 p-4 md:p-8 pt-24 md:pt-10 h-screen overflow-y-auto touch-scroll">
                        {page === 'dashboard' && <Dashboard db={db} userRole={userRole} currentUser={currentUser}/>}
                        
                        {page === 'mahasiswa' && <GenericTable   
                            key="tbl-mhs"   
                            title="Data Mahasiswa & TA"   
                            data={(() => {
                                let rawData = db['Mahasiswa Tugas Akhir'] || [];
                                if (userRole === 'dosen' && currentUser?.Nama) {
                                    const myName = String(currentUser.Nama).trim().toLowerCase();
                                    rawData = rawData.filter(m => {
                                        const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                                        const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                                        const penguji = String(m.Penguji || '').trim().toLowerCase();
                                        return p1 === myName || p2 === myName || penguji === myName;
                                    });
                                }
                                const uniqueData = new Map();
                                rawData.forEach(item => {
                                    if (item.NPM) uniqueData.set(String(item.NPM).trim(), item);
                                    else uniqueData.set(item.id, item);  
                                });
                                return Array.from(uniqueData.values());
                            })()}
                            columns={TABLE_CONFIG['Mahasiswa Tugas Akhir'].columns}   
                            formConfig={mahasiswaFormConfig}   
                            onAdd={(d) => handleStudentChange('add', null, d)}   
                            onDel={(id) => handleStudentChange('delete', id)}   
                            onUpdate={(id, d) => handleStudentChange('update', id, d)}
                            onImport={data => importBatch('Mahasiswa Tugas Akhir', data)}
                            allowAdd={userRole==='admin'}   
                            allowDelete={userRole==='admin'}
                            allowEdit={userRole==='admin'}
                            allowImport={userRole==='admin'}
                            statusFilterConfig={{
                                key: 'Status',
                                options: ['Belum Proposal', 'Sudah Proposal', 'Sudah Hasil', 'Sudah Sidang', 'Lulus']
                            }}
                        />}
                        
                        {page === 'tugas_akhir' && userRole === 'dosen' && <GenericTable   
                            key="tbl-ta-dosen"
                            title="Tugas Akhir Mahasiswa (Detail)"   
                            data={(() => {
                                let rawData = db['Mahasiswa Tugas Akhir'] || [];
                                const myName = String(currentUser.Nama).trim().toLowerCase();
                                rawData = rawData.filter(m => {
                                    const p1 = String(m.Pembimbing_1 || '').trim().toLowerCase();
                                    const p2 = String(m.Pembimbing_2 || '').trim().toLowerCase();
                                    const penguji = String(m.Penguji || '').trim().toLowerCase();
                                    return p1 === myName || p2 === myName || penguji === myName;
                                });
                                const uniqueData = new Map();
                                rawData.forEach(item => {
                                    if (item.NPM) uniqueData.set(String(item.NPM).trim(), item);
                                    else uniqueData.set(item.id, item);
                                });
                                return Array.from(uniqueData.values());
                            })()}
                            columns={TABLE_CONFIG['Tugas Akhir Mahasiswa (Dosen)'].columns}   
                            formConfig={[]}   
                            allowAdd={false}   
                            allowDelete={false}
                            allowEdit={false}   
                            allowImport={false}
                        />}

                        {page === 'dosen' && <GenericTable   
                            key="tbl-dosen"
                            title="Data Dosen"   
                            data={db['Data Dosen']}   
                            columns={TABLE_CONFIG['Data Dosen'].columns}   
                            formConfig={TABLE_CONFIG['Data Dosen'].form}   
                            onAdd={d=>add('Data Dosen',d)}   
                            onDel={id=>del('Data Dosen',id)}   
                            onUpdate={(id, d)=>update('Data Dosen', id, d)}
                            onImport={data=>importBatch('Data Dosen', data)}   
                            allowAdd={userRole==='admin'}   
                            allowDelete={userRole==='admin'}   
                            allowEdit={userRole==='admin'}   
                            allowImport={userRole==='admin'}
                        />}

                        {page === 'peminatan' && <GenericTable   
                            key="tbl-peminatan"
                            title="Data Peminatan"   
                            data={db['Data Peminatan']}   
                            columns={TABLE_CONFIG['Data Peminatan'].columns}   
                            formConfig={TABLE_CONFIG['Data Peminatan'].form}   
                            onAdd={d=>add('Data Peminatan',d)}   
                            onDel={id=>del('Data Peminatan',id)}   
                            onUpdate={(id, d)=>update('Data Peminatan', id, d)}
                            allowAdd={userRole==='admin'}   
                            allowDelete={userRole==='admin'}   
                            allowEdit={userRole==='admin'}
                        />}
                        
                        {page === 'sidang' && <GenericTable   
                            key="tbl-sidang"
                            title="Jadwal Ujian"   
                            data={(() => {
                                let data = jadwalData;
                                if (userRole === 'dosen' && currentUser?.Nama) {
                                     const myName = String(currentUser.Nama).trim().toLowerCase();
                                     data = data.filter(j => {
                                         const p1 = String(j["Pembimbing 1"] || '').trim().toLowerCase();
                                         const p2 = String(j["Pembimbing 2"] || '').trim().toLowerCase();
                                         const pengujiMhs = String(j["Penguji Mahasiswa"] || '').trim().toLowerCase();
                                         const pengujiJadwal = String(j.Penguji_1 || '').trim().toLowerCase();

                                         return p1 === myName || p2 === myName || pengujiMhs === myName || pengujiJadwal === myName;
                                     });
                                }
                                return data;
                            })()}   
                            columns={TABLE_CONFIG['Jadwal Ujian TA'].columns}   
                            formConfig={jadwalFormConfig}   
                            onAdd={d=>add('Jadwal Ujian TA',d)}   
                            onDel={id=>del('Jadwal Ujian TA',id)}   
                            onImport={data=>importBatch('Jadwal Ujian TA', data)}
                            allowAdd={userRole==='admin' || userRole==='tendik'}   
                            allowDelete={userRole==='admin' || userRole==='tendik'}
                            allowImport={userRole==='admin'}
                        />}
                        
                        {page === 'informasi' && <GenericTable   
                            key="tbl-info"
                            title="Papan Informasi & Pengumuman"   
                            data={db['Informasi'] || []}   
                            columns={TABLE_CONFIG['Informasi'].columns}   
                            formConfig={TABLE_CONFIG['Informasi'].form}   
                            onAdd={d => add('Informasi', { ...d, Penulis: currentUser?.Nama || (userRole === 'admin' ? 'Admin' : 'Staf') })}   
                            onDel={id=>del('Informasi',id)}   
                            onUpdate={(id, d)=>update('Informasi', id, d)}
                            allowAdd={userRole==='admin' || userRole==='dosen' || userRole==='tendik'}   
                            allowDelete={userRole==='admin' || userRole==='dosen' || userRole==='tendik'}
                            allowEdit={userRole==='admin' || userRole==='dosen' || userRole==='tendik'}
                        />}

                        {page === 'administrasi' && <AdministrasiMenu setPage={setPage} config={config} userRole={userRole} />}
                        
                        {PAGE_MAP[page] && (
                            <GenericTable   
                                key={`tbl-admin-${page}`}
                                title={PAGE_MAP[page].title}
                                data={db[PAGE_MAP[page].collection] || []}
                                columns={TABLE_CONFIG[PAGE_MAP[page].configKey].columns}
                                formConfig={TABLE_CONFIG[PAGE_MAP[page].configKey].form}
                                onAdd={(d) => {
                                    if(page === 'pengajuan_judul') {
                                        handlePengajuanJudul(d);
                                    } else if(PAGE_MAP[page].status) {
                                        handleRegistration(PAGE_MAP[page].collection, d, PAGE_MAP[page].status);
                                    } else {
                                        add(PAGE_MAP[page].collection, d);
                                        alert('Data Tersimpan!');
                                    }
                                }}
                                onDel={id=>del(PAGE_MAP[page].collection, id)}
                                onImport={data=>importBatch(PAGE_MAP[page].collection, data)}
                                allowAdd={userRole==='admin'}   
                                allowDelete={userRole==='admin'}
                                allowImport={userRole==='admin'}
                                gformUrl={getGformUrl(page)}
                                onBack={()=>setPage('administrasi')}
                            />
                        )}

                        {page === 'unduh' && <GenericTable
                            key="tbl-unduh"
                            title="Pusat Unduhan Berkas"
                            data={db['Data Unduhan'] || []}
                            columns={TABLE_CONFIG['Data Unduhan'].columns}
                            formConfig={TABLE_CONFIG['Data Unduhan'].form}
                            onAdd={d=>add('Data Unduhan',d)}
                            onDel={id=>del('Data Unduhan',id)}
                            onImport={data=>importBatch('Data Unduhan', data)}
                            allowAdd={userRole==='admin'}
                            allowDelete={userRole==='admin'}
                            allowImport={userRole==='admin'}
                        />}

                        {page === 'progres' && userRole === 'mahasiswa' && (
                            <StudentProgress db={db} currentUser={currentUser} onUpdate={(collection, id, data) => update(collection, id, data)} />
                        )}

                        {/* --- GUIDANCE PAGE --- */}
                        {page === 'bimbingan' && (userRole === 'mahasiswa' || userRole === 'dosen') && (
                            <BimbinganPage currentUser={currentUser} userRole={userRole} db={db} add={add} update={update} />
                        )}
                        
                        {page === 'settings' && userRole === 'admin' && (
                            <div className="max-w-lg mx-auto glass p-8 rounded-3xl shadow-xl border border-white/60 animate-slide-up">
                                <h2 className="text-2xl font-bold mb-8 text-purple-900 text-center flex items-center justify-center gap-2"><Icon path={PATHS.Cog}/> Pengaturan Sistem</h2>
                                <div className="space-y-5">
                                    <div><label className="text-xs font-bold text-purple-800/70 uppercase mb-2 block">Nama Aplikasi</label><input className="input-modern" value={config.app_name} onChange={e=>setConfig(p=>({...p,app_name:e.target.value}))}/></div>
                                    <div><label className="text-xs font-bold text-purple-800/70 uppercase mb-2 block">Google Sheet Script URL</label><input className="input-modern" placeholder="https://script.google.com/..." value={config.scriptUrl} onChange={e=>setConfig(p=>({...p,scriptUrl:e.target.value}))}/></div>
                                    <div className="pt-4 border-t border-purple-100">
                                        <p className="text-sm font-bold text-purple-900 mb-4">Link Google Form (Pendaftaran)</p>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="col-span-2"><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Pengajuan Judul</label><input className="input-modern" value={config.gform_pengajuan_judul || ''} onChange={e=>setConfig(p=>({...p,gform_pengajuan_judul:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Sempro</label><input className="input-modern" value={config.gform_sempro || ''} onChange={e=>setConfig(p=>({...p,gform_sempro:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Semhas</label><input className="input-modern" value={config.gform_semhas || ''} onChange={e=>setConfig(p=>({...p,gform_semhas:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Sidang</label><input className="input-modern" value={config.gform_sidang || ''} onChange={e=>setConfig(p=>({...p,gform_sidang:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Surat</label><input className="input-modern" value={config.gform_surat || ''} onChange={e=>setConfig(p=>({...p,gform_surat:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Yudisium</label><input className="input-modern" value={config.gform_yudisium || ''} onChange={e=>setConfig(p=>({...p,gform_yudisium:e.target.value}))}/></div>
                                            <div><label className="text-[10px] font-bold text-purple-500 uppercase block">Form Laporan TA</label><input className="input-modern" value={config.gform_laporan_ta || ''} onChange={e=>setConfig(p=>({...p,gform_laporan_ta:e.target.value}))}/></div>
                                        </div>
                                    </div>
                                    <button onClick={()=>{refresh(); alert('Pengaturan Disimpan!')}} className="w-full bg-purple-600 text-white py-3.5 rounded-xl font-bold hover:bg-purple-700 transition shadow-lg shadow-purple-500/30">Simpan & Refresh</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {showLogin && (
                        <div className="fixed inset-0 bg-purple-900/40 backdrop-blur-md flex items-center justify-center z-50 p-4 animate-fade-in">
                            <LoginCard isModal={true} db={db} handleRoleLogin={handleRoleLogin} setShowLogin={setShowLogin} onRefresh={refresh} isLoading={isLoading} />
                        </div>
                    )}

                    {notification && (
                        <NotificationPopup data={notification} onClose={() => setNotification(null)} />
                    )}

                    {/* --- CHATBOT COMPONENT --- */}
                    <ChatBot   
                        db={db}   
                        currentUser={currentUser}   
                        userRole={userRole}
                        isOpen={isChatOpen}   
                        onToggle={() => setIsChatOpen(!isChatOpen)}   
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
